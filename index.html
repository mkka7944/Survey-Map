<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Field Staff Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root { 
            --primary: #2563eb; --warning: #f59e0b; --danger: #ef4444; --text: #1e293b; --bg: #f8fafc; 
            --sidebar-w: 320px; --sidebar-collapsed-w: 0px;
            --spacer: 16px; --spacer-lg: 24px;
            --font-xs: 11px; --font-sm: 13px; --font-base: 14px; --font-md: 16px; --font-lg: 18px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; height: 100vh; display: flex; overflow: hidden; background: var(--bg); font-size: var(--font-base); color: var(--text); }
        
        /* Layout */
        #sidebar { 
            width: var(--sidebar-w); background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(20px); border-right: 1px solid rgba(226, 232, 240, 0.8); 
            display: flex; flex-direction: column; z-index: 2000; box-shadow: 0 0 40px rgba(0,0,0,0.03);
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden; 
        }
        #sidebar.collapsed { 
            width: 0;
            border-right: none;
        }
        
        /* Desktop Toggle Button */
        #sidebar-toggle {
            position: absolute; left: 0; top: 12px; width: 32px; height: 38px;
            background: white; border: 1px solid #e2e8f0; border-left: none;
            border-radius: 0 8px 8px 0; display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: black; z-index: 3000; box-shadow: 2px 0 8px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }
        #sidebar-toggle:hover { background: #f8fafc; color: var(--primary); }
        #sidebar-toggle i { transition: transform 0.4s; font-weight: bold; }
        .collapsed-toggle i { transform: rotate(180deg); }
        #main-stage { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .hide-map-ui #sidebar-toggle, .hide-map-ui .map-controls, .hide-map-ui #info-card { display: none !important; }
        #map-container { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; background: #ddd; }
        .leaflet-container img.leaflet-tile { outline: 1px solid transparent; }
        .leaflet-container * { box-sizing: content-box; }

        /* Fullscreen List View */
        #list-view-stage { 
            position: absolute; inset: 0; background: var(--bg); z-index: 5000; 
            display: none; flex-direction: column; overflow: hidden; 
        }
        #list-view-stage.active { display: flex; }
        
        .list-nav { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 16px; background: white; border-bottom: 1px solid #e2e8f0;
        }

        .record-card {
            flex: 1; display: flex; flex-direction: column; padding: 0 24px 24px 24px;
            max-width: 600px; margin: 0 auto; width: 100%; overflow-y: auto;
        }
        .card-header { margin-bottom: 8px; border-bottom: 1px solid #f1f5f9; padding-bottom: 6px; }
        .card-title { font-size: var(--font-lg); font-weight: 700; color: var(--text); }
        .card-grid { 
            display: grid; 
            grid-template-columns: repeat(var(--grid-cols, 3), 1fr); 
            gap: 12px; 
            margin-bottom: 20px; 
            padding: 4px 12px 12px 12px;
        }
        .grid-item { display: flex; flex-direction: column; gap: 6px; }
        .grid-label { font-size: var(--font-xs); font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .grid-val { font-size: var(--font-base); font-weight: 500; color: var(--text); }

        .card-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .gallery-thumb { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .gallery-thumb:hover { border-color: var(--primary); transform: translateY(-2px); }

        /* Sidebar UI refinements */
        .filters { padding: 12px var(--spacer) 40px var(--spacer); display: flex; flex-direction: column; gap: 8px; }
        .filter-group { display: flex; flex-direction: column; gap: 4px; transition: all 0.3s; margin-bottom: 4px; }
        .filter-group.collapsed { gap: 0; }
        .filter-group.collapsed .multi-select-container { display: none; }
        .filter-group.collapsed .filter-content { display: none; }
        .filter-group.collapsed #f-start-container, .filter-group.collapsed #f-end-container { display: none; }
        
        .selection-badge {
            background: #eff6ff; color: #2563eb; font-size: 10px; font-weight: 800;
            padding: 2px 8px; border-radius: 20px; border: 1.5px solid #dbeafe;
            display: inline-flex; align-items: center; justify-content: center;
            text-transform: none; line-height: 1; height: 18px; min-width: 22px;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
            margin-left: auto; flex-shrink: 0;
        }
        
        .filter-label { 
            font-size: 11px; font-weight: 800; color: #1e293b; 
            text-transform: uppercase; letter-spacing: 0.6px;
            display: flex; align-items: center; gap: 6px; flex: 1;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        
        .toggle-group-btn {
            width: 24px; height: 24px; border-radius: 50%; border: 1.5px solid #e2e8f0;
            background: white; color: #64748b; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; font-size: 16px;
        }
        .toggle-group-btn:hover { background: #eff6ff; color: var(--primary); border-color: #bfdbfe; }
        .filter-group.collapsed .toggle-group-btn i { transform: rotate(-90deg); }
        .panel-header-premium {
            background: white; border: 1.5px solid #e2e8f0; border-radius: 12px;
            padding: 8px 12px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; align-items: center; gap: 8px; min-height: 40px;
        }
        .panel-header-premium:hover { background: #f8fafc; border-color: var(--primary); transform: translateX(4px); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.08); }
        .filter-group.active-group .panel-header-premium { border-color: var(--primary); background: #eff6ff; }
        
        .panel-header-premium.action-btn-premium { border-color: transparent; }
        
        /* Sidebar Footer Styles */
        .sidebar-footer {
            margin-top: auto; padding: 12px 16px; 
            background: white; border-top: 1px solid #e2e8f0;
            display: flex; gap: 6px; z-index: 2100;
        }
        .footer-btn {
            flex: 1; height: 40px; border-radius: 10px; border: 1.5px solid #e2e8f0;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            font-size: 11px; font-weight: 800; text-transform: uppercase; cursor: pointer;
            transition: all 0.2s;
        }
        .footer-btn.apply { background: var(--primary); color: white; border-color: var(--primary); }
        .footer-btn.today { background: #0ea5e9; color: white; border-color: #0ea5e9; }
        .footer-btn.reset { background: #ef4444; color: white; border-color: #ef4444; }
        .footer-btn:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        /* Nested Accordion Content */
        .nested-content { display: none; padding: 6px 12px 10px 12px; }
        .filter-group:not(.collapsed) .nested-content { display: block; }
        .sub-tool-item {
            display: flex; align-items: center; gap: 10px; padding: 8px 12px;
            border-radius: 8px; font-size: 12px; font-weight: 700; color: #475569;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer;
        }
        .sub-tool-item:hover { background: #eff6ff; color: var(--primary); transform: translateX(4px); }
        .sub-tool-item .material-icons-round { font-size: 20px; }
        
        .stat-badge {
            margin: 4px var(--spacer); padding: 10px 14px; border-radius: 12px; 
            background: #f1f5f9; display: flex; justify-content: space-between; 
            align-items: center; border: 1.5px solid #e2e8f0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: default;
        }
        .stat-badge:hover { transform: translateX(4px); background: #eff6ff; border-color: var(--primary); }
        
        
        
        /* Modernized Multi-Select List */
        .multi-select-container { 
            border: 1px solid #e2e8f0; border-radius: 10px; background: #fdfdfd; 
            max-height: 180px; overflow-y: auto; padding: 6px; display: flex; flex-direction: column; gap: 4px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }
        #f-pay.multi-select-container {
            flex-direction: row; flex-wrap: wrap; gap: 8px; max-height: none;
        }
        #f-pay .multi-option {
            padding: 6px 10px; flex: 1; justify-content: center; min-width: 80px;
        }
        .multi-option { 
            display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 8px; 
            font-size: var(--font-sm); color: var(--text); cursor: pointer; transition: all 0.15s ease;
            user-select: none; border: 1px solid transparent;
        }
        .multi-option:hover { background: #f8fafc; border-color: #f1f5f9; }
        .multi-option input { 
            width: 18px; height: 18px; border-radius: 5px; border: 2px solid #cbd5e1; 
            accent-color: var(--primary); margin: 0; cursor: pointer;
        }
        .multi-option.selected { background: #eff6ff; color: var(--primary); font-weight: 600; border-color: #dbeafe; }
        .multi-option span { flex: 1; pointer-events: none; }
        
        .filter-header { 
            display: flex; justify-content: space-between; align-items: center; padding: 4px 0;
            min-height: 28px; width: 100%;
        }
        .filter-actions { display: flex; gap: 4px; border-left: 1px solid #e2e8f0; padding-left: 8px; margin-left: auto; }
        .select-all-btn { 
            background: #f8fafc; border: 1.5px solid #e2e8f0; color: #64748b;
            font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 6px;
            cursor: pointer; transition: all 0.2s; text-transform: uppercase;
        }
        .select-all-btn:hover { background: #eff6ff; color: var(--primary); border-color: #bfdbfe; }
        .select-all-btn.unselect:hover { background: #fef2f2; color: #ef4444; border-color: #fee2e2; }
        .select-all-btn.unselect { color: #64748b; background: #f8fafc; }

        .apply-btn { 
            padding: 14px; background: var(--primary); color: white; border: none; 
            border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; 
            justify-content: center; gap: 10px; font-size: var(--font-base);
            box-shadow: 0 4px 14px rgba(37, 99, 235, 0.3); transition: all 0.2s;
        }
        .apply-btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .apply-btn:active { transform: translateY(0); }
        
        .secondary-btn {
            width:100%; padding:12px; border-radius:10px; border:1px solid #e2e8f0; 
            background:white; font-weight:600; font-size: 13px; display:flex; align-items:center; gap:8px;
            transition: all 0.2s; margin-bottom: 8px;
        }
        .secondary-btn:hover { background: #f8fafc; border-color: #cbd5e1; }
        .secondary-btn span { font-size: 20px; }

        .stat-badge {
            background: #eff6ff; color: #1e40af; padding: 8px 16px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid #dbeafe; margin: 12px 16px; box-shadow: 0 2px 4px rgba(30, 64, 175, 0.05);
        }
        .stat-badge span { font-size: 20px; font-weight: 800; }
        .stat-badge small { font-size: 11px; text-transform: uppercase; font-weight: 700; opacity: 0.9; letter-spacing: 0.3px; }

        .guide-box {
            background: #fafafa; border: 1px solid #f1f5f9; border-radius: 12px;
            padding: 16px; margin: 0 24px 20px; color: #475569; font-size: 13px;
            text-align: center;
        }
        .guide-box-content { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; align-items: center; }

        /* Settings UI Tweaks */
        .settings-tab-btn {
            padding: 8px 14px; border: 1px solid #e2e8f0; background: #f8fafc;
            color: #64748b; font-weight: 500; border-radius: 20px; font-size: 11px;
            white-space: nowrap; cursor: pointer; transition: all 0.2s;
        }
        .settings-tab-btn.active {
            background: #eff6ff; color: #2563eb; font-weight: 700; border-color: #bfdbfe;
        }
        .settings-tabs-row {
            display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 8px; 
            padding: 16px 20px; background: #fff; border-bottom: 1px solid #f1f5f9;
            scrollbar-width: none; -ms-overflow-style: none; /* Hide scrollbar for Chrome/Safari */
        }
        .settings-tabs-row::-webkit-scrollbar { display: none; }
        .kml-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        @media (max-width: 480px) {
            .kml-grid { grid-template-columns: 1fr; }
        }
        .settings-footer {
            position: absolute; bottom: 0; left: 0; right: 0; padding: 16px;
            background: white; border-top: 1px solid #e2e8f0; display: flex; gap: 12px;
            border-radius: 0 0 16px 16px; z-index: 10;
        }
        .tab-group-label {
            width: 100%; font-size: 10px; font-weight: 800; color: #94a3b8;
            text-transform: uppercase; letter-spacing: 1px; margin: 8px 0 4px 4px;
        }
        .guide-item { 
            display: flex; align-items: center; gap: 8px; white-space: nowrap; 
            background: #fff; padding: 6px 14px; border-radius: 20px; border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .guide-item i { font-size: 16px; }
        .guide-item b { color: #1e293b; font-weight: 700; }
        .guide-item span.penalty { 
            background: #fee2e2; color: #b91c1c; font-size: 10px; padding: 2px 6px; 
            border-radius: 6px; font-weight: 800; margin-left: 4px;
        }
        .guide-box h4 { color: #1e293b; font-size: 14px; margin: 0 0 12px 0; font-weight: 700; }
        .fail-mark { color: #ef4444; font-size: 16px; margin-left: 2px; vertical-align: middle; }
        .pass-mark { color: #22c55e; font-size: 16px; margin-left: 2px; vertical-align: middle; }
        .score-box { display: flex; align-items: center; justify-content: center; gap: 4px; }

        button { cursor: pointer; font-family: inherit; }

        /* Leaderboard */
        .rank-row { border-bottom: 1px solid #f1f5f9; transition: background 0.1s; font-size: 15px; }
        .rank-row:hover { background: #f8fafc; }
        .trophy { margin-left: 6px; display: inline-block; vertical-align: middle; }
        .trophy.gold { font-size: 28px; filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.4)); }
        .trophy.silver { font-size: 20px; filter: drop-shadow(0 0 3px rgba(148, 163, 184, 0.3)); }
        .trophy.bronze { font-size: 18px; filter: drop-shadow(0 0 3px rgba(180, 83, 9, 0.2)); }
        
        .idle-warn { color: var(--warning); font-weight: 700; }
        .idle-danger { color: var(--danger); font-weight: 700; }
        .time-warning { color: var(--danger); font-weight: 800; animation: blink 2s infinite; }
        @keyframes blink { 50% { opacity: 0.6; } }

        .stats-table-container { width: 100%; overflow-x: auto; }
        .count-badge { 
            padding: 6px 14px; border-radius: 24px; font-weight: 800; font-size: 14px;
            background: #f1f5f9; color: #475569; display: inline-block; min-width: 50px; text-align: center;
        }
        .count-high { background: #dcfce7; color: #166534; box-shadow: 0 0 10px rgba(22, 101, 52, 0.1); }
        .status-msg { font-size: 10px; font-weight: 700; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; }
        .status-idle { background: #fee2e2; color: #991b1b; }
        .status-warn { background: #fef3c7; color: #92400e; }
        .status-ok { background: #f0fdf4; color: #166534; }

        /* Modern Tooltip */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 220px !important; }
        .pop-card { padding: 12px; }
        .pop-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; color: var(--primary); }

        /* Advanced Gallery */
        .gallery-overlay { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; 
            flex-direction: column; transition: opacity 0.3s;
        }
        .gallery-overlay.active { display: flex; }
        .gal-header { padding: 16px; display: flex; justify-content: flex-end; color: white; }
        .gal-viewport { flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; touch-action: none; }
        .gal-img { max-width: 90%; max-height: 80%; object-fit: contain; transition: transform 0.2s cubic-bezier(0.1, 0, 0.2, 1); user-select: none; pointer-events: auto; -webkit-user-drag: none; user-drag: none; }
        .gal-img.no-transition { transition: none !important; }
        
        .rotate { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .gal-controls { 
            padding: 20px; display: flex; justify-content: center; gap: 15px; 
            background: linear-gradient(transparent, rgba(0,0,0,0.5));
        }
        .gal-btn { 
            width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.1); 
            border: 1px solid rgba(255,255,255,0.2); color: white; display: flex; 
            align-items: center; justify-content: center; backdrop-filter: blur(8px); cursor: pointer;
        }

        /* Floating Controls */
        .map-controls { 
            position: absolute; bottom: 24px; right: 24px; z-index: 1000; 
            display: flex; flex-direction: column; gap: 12px; align-items: flex-end;
        }
        .control-group { 
            display: flex; flex-direction: column; gap: 8px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            opacity: 1; transform: translateY(0);
        }
        .control-group.collapsed { 
            height: 0; opacity: 0; transform: translateY(10px); pointer-events: none; margin-bottom: -12px;
        }
        .float-btn { 
            width: 48px; height: 48px; border-radius: 50%; background: white; 
            color: var(--text); border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: all 0.2s; z-index: 1001;
        }
        .float-btn:hover { background: #f1f5f9; transform: scale(1.05); }
        .float-btn:active { transform: scale(0.95); }
        .float-btn.primary { background: var(--primary); color: white; }
        .float-btn .material-icons-round { font-size: 24px; }

        /* Info Card Defaults */
        #info-card {
            position: absolute; top: 12px; left: 50px; z-index: 1000;
            background: rgba(255, 255, 255, 0.94);
            backdrop-filter: blur(10px);
            border: 1px solid white;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            border-radius: 12px;
            padding: 8px 12px;
            width: 340px;
            opacity: 1;
            transform: translateY(0);
            max-height: calc(100vh - 40px);
            display: flex; flex-direction: column;
            transition: opacity 0.3s, transform 0.3s;
        }
        #info-card.hidden { opacity: 0; transform: translateY(-10px); pointer-events: none; }
        
        .info-stat-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(0,0,0,0.04); gap: 8px; }
        #info-card.minimized {
            width: auto; height: auto; min-width: 0;
            padding: 8px 12px;
            border-radius: 20px;
        }
        .info-label { font-size: 12px; font-weight: 600; color: #64748b; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .info-val { font-size: 13px; font-weight: 700; color: #1e293b; display: flex; gap: 4px; flex-shrink: 0; }
        .pill { font-size: 10px; padding: 1px 5px; border-radius: 4px; font-weight: 800; white-space: nowrap; }
        .pill.dom { background: #dcfce7; color: #166534; }
        .pill.com { background: #fef3c7; color: #92400e; }

        .pill.paid { background: #dcfce7; color: #166534; }
        .pill.unpaid { background: #fee2e2; color: #991b1b; }
        .pill.not-billed { background: #f1f5f9; color: #475569; }
        .pill-lg { font-size: 13px; padding: 3px 10px; border-radius: 6px; }
        
        /* Collapsed logic */
        .filter-group.collapsed .multi-select-container,
        .filter-group.collapsed .filter-content,
        .filter-group.collapsed .filter-actions {
            display: none !important;
        }

        .address-bold { font-weight: 800 !important; color: #0f172a !important; }
        .area-small { font-size: 11px !important; opacity: 0.8; }

        .toggle-btn-container {
            display: flex; align-items: center; justify-content: space-between;
            background: #f8fafc; padding: 10px 14px; border-radius: 12px;
            border: 1px solid #e2e8f0; margin-top: 12px;
        }
        .toggle-switch {
            position: relative; display: inline-block; width: 44px; height: 24px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; inset: 0; background-color: #cbd5e1;
            transition: .3s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
            background-color: white; transition: .3s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

        @media (max-width: 768px) {
            #sidebar { 
                position: fixed; left: -100%; top: 0; bottom: 0; width: var(--sidebar-w); 
                z-index: 2000; transform: none;
            }
            #sidebar.collapsed { width: var(--sidebar-w); transform: none; left: -100%; }
            #sidebar.open { left: 0; box-shadow: 0 0 100px rgba(0,0,0,0.5); }
            #sidebar-toggle { display: none; }
            .mobile-only { display: block; }
            .map-controls { bottom: 90px; right: 20px; }
            
            #sidebar header div:first-child div:first-child { font-size: 14px !important; }
            .filter-label { font-size: 10px !important; }
            .sidebar-header-padding { padding: 12px 12px 4px 12px !important; }

            /* Compact Filters on Mobile */
            .multi-select-container { max-height: 120px !important; }
            
            /* Info Card Mobile */
            #info-card { 
                left: 50%; transform: translateX(-50%); 
                width: 96%; max-width: 420px; 
                top: 12px; 
                max-height: 40vh; /* Prevent covering too much map */
                z-index: 1000;
            }
            #info-card.hidden { display: none !important; opacity: 0; pointer-events: none; }
            
            /* Very small screens */
            @media (max-width: 380px) {
                .info-label { font-size: 11px !important; }
                .info-val { font-size: 11px !important; }
                .pill { font-size: 9px !important; padding: 1px 3px !important; }
            }
            
            .modal-header { flex-direction: column; align-items: stretch !important; gap: 16px; padding: 16px !important; }
            .modal-header > div { width: 100%; justify-content: space-between; }
            .perf-table th, .perf-table td { padding: 10px 4px !important; font-size: 12px; }
            .modal-header input[type="date"] { font-size: 13px; max-width: 110px; }
            
            /* Grid Shift */
            .card-grid { --grid-cols: 2; gap: 8px; }
            .grid-item div { font-size: 12px !important; }

            /* Mobile Button Fixes */
            .apply-btn { font-size: 11px !important; padding: 10px 4px !important; gap: 4px !important; }
            #f-start, #f-end { width: 100% !important; box-sizing: border-box !important; }
        }

        /* Sync Station (v4.2 Premium) */
        .sync-station {
            margin-top: 24px; margin-bottom: 24px; padding: 20px;
            background: rgba(248, 250, 252, 0.8); backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8); border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            display: flex; flex-direction: column; gap: 16px;
        }
        
        .sync-station-header {
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .sync-station-title {
            font-size: 11px; font-weight: 800; color: #64748b;
            text-transform: uppercase; letter-spacing: 1px;
        }
        
        .sync-status-badge {
            font-size: 10px; font-weight: 700; color: var(--primary);
            background: #eff6ff; padding: 4px 10px; border-radius: 20px;
            border: 1px solid #dbeafe;
        }
        
        .sync-select-wrapper { position: relative; width: 100%; }
        .sync-select-wrapper select {
            width: 100%; padding: 12px 16px; border-radius: 12px;
            border: 1.5px solid #e2e8f0; background: white;
            font-size: 14px; font-weight: 600; color: var(--text);
            cursor: pointer; appearance: none; transition: all 0.2s;
        }
        .sync-select-wrapper select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .sync-select-wrapper::after {
            content: '\e5cf'; font-family: 'Material Icons Round';
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            color: #94a3b8; pointer-events: none; font-size: 20px;
        }
        
        .sync-action-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
        }
        
        .sync-action-btn {
            height: 52px; border-radius: 14px; border: none;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-weight: 800; font-size: 13px; cursor: pointer; transition: all 0.2s;
        }
        .sync-action-btn.camera {
            background: white; color: var(--primary); border: 2px solid var(--primary);
        }
        .sync-action-btn.camera:hover { background: #f0f7ff; }
        
        .sync-action-btn.upload {
            background: #10b981; color: white; border: none;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }
        .sync-action-btn.upload:hover { background: #059669; transform: translateY(-1px); }
        .sync-action-btn.upload:active { transform: translateY(0); }
        .sync-action-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .sync-preview-strip {
            display: flex; gap: 10px; overflow-x: auto; padding: 4px;
            scrollbar-width: none; /* Firefox */
        }
        .sync-preview-strip::-webkit-scrollbar { display: none; } /* Chrome/Safari */
        
        .preview-item {
            position: relative; width: 64px; height: 64px; flex-shrink: 0;
            border-radius: 10px; overflow: hidden; border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        .preview-item .remove-btn {
            position: absolute; top: 2px; right: 2px;
            background: #ef4444; color: white; border: none;
            width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        @media (max-width: 480px) {
            .sync-action-grid { grid-template-columns: 1fr; }
            .sync-action-btn { height: 56px; font-size: 14px; }
        }


        /* KML Validation & UI */
        .toast-msg {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px;
            font-size: 13px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none; z-index: 9999;
        }
        .toast-msg.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        /* Quick Filter Panel */
        .quick-filter-panel { display: flex; gap: 8px; margin-top: 12px; padding: 0 4px; flex-wrap: wrap; }
        .quick-pill { 
            flex: 1; padding: 8px 12px; border-radius: 50px; font-size: 11px; font-weight: 800; 
            text-transform: uppercase; cursor: pointer; transition: all 0.2s; 
            display: flex; align-items: center; justify-content: center; gap: 6px;
            background: #f1f5f9; color: #64748b; border: 1.5px solid #e2e8f0;
        }
        .quick-pill:hover { background: #e2e8f0; }
        .quick-pill.active { background: #eff6ff; color: var(--primary); border-color: #bfdbfe; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1); }
        .quick-pill.active i { color: var(--primary); }
        .quick-pill i { font-size: 14px; color: #94a3b8; }

        /* Paid Bills Dashboard Stage - v7.2 Advanced Analytics */
        #paid-dashboard-stage {
            position: fixed; inset: 0; z-index: 8000;
            background: #f8fafc; display: none; flex-direction: column;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .dash-layout {
            flex: 1; display: grid; grid-template-columns: 320px 1fr;
            overflow: hidden; height: 100%; background: #f1f5f9;
            transition: grid-template-columns 0.3s ease;
        }

        .dash-layout.sidebar-collapsed {
            grid-template-columns: 0px 1fr;
        }

        .dash-sidebar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(226, 232, 240, 0.8);
            display: flex; flex-direction: column; overflow-y: auto;
            padding: 24px 20px;
            transition: transform 0.3s ease, padding 0.3s ease;
        }
        
        .dash-layout.sidebar-collapsed .dash-sidebar {
            transform: translateX(-320px);
            padding: 24px 0;
            overflow: hidden;
        }

        .dash-main-content {
            display: flex; flex-direction: column; overflow: hidden;
            background: white; border-radius: 0;
            box-shadow: 0 0 40px rgba(0,0,0,0.05);
        }

        .dashboard-header {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center;
        }

        .dashboard-stats-grid {
            padding: 20px 30px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            background: #f8fafc;
            border-bottom: 1px solid #f1f5f9;
        }

        .dash-stat-card {
            padding: 16px;
            border-radius: 14px;
            background: white;
            border: 1px solid #e2e8f0;
            display: flex; align-items: center; gap: 12px;
            transition: all 0.2s;
        }
        .dash-stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.04); }
        
        .dash-stat-icon {
            width: 40px; height: 40px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
        }
        
        .dash-stat-info { flex: 1; }
        .dash-stat-label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .dash-stat-value { font-size: 18px; font-weight: 800; color: #1e293b; }

        .dash-filters {
            padding: 16px 30px;
            background: white;
            border-bottom: 1px solid #f1f5f9;
            display: flex; gap: 12px; flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .dash-filter-item { flex: 1; min-width: 140px; }
        .dash-filter-item label {
            display: block; font-size: 9px; font-weight: 800; color: #94a3b8; 
            margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .dash-filter-item select, .dash-filter-item input {
            width: 100%; padding: 12px 16px; border-radius: 12px;
            border: 1.5px solid #e2e8f0; background: #f8fafc;
            font-size: 14px; font-weight: 600; color: var(--text);
            transition: all 0.2s; outline: none;
            cursor: pointer;
        }
        .dash-filter-item select {
            appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 12px center; background-size: 16px;
        }
        .dash-filter-item select:focus, .dash-filter-item input:focus {
            border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }
        
        .paid-table-container { flex: 1; overflow: auto; background: white; }
        .paid-table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 1300px; }
        .paid-table th { 
            position: sticky; top: 0; background: #f8fafc; z-index: 10;
            text-align: left; padding: 14px 12px; border-bottom: 2px solid #e2e8f0;
            color: #475569; font-weight: 800; text-transform: uppercase; font-size: 10px;
            letter-spacing: 0.5px;
        }
        .paid-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        .paid-table tr:hover { background: #f8fafc; cursor: pointer; }
        .paid-table tr:hover td { color: var(--primary); }
        
        .paid-id-link { 
            display: inline-block; padding: 4px 10px; background: #eff6ff;
            color: var(--primary); font-weight: 800; border-radius: 6px;
            text-decoration: none; border: 1px solid #dbeafe;
        }
        .paid-deleted-id { 
            display: inline-block; padding: 4px 10px; background: #fee2e2;
            color: #ef4444; font-weight: 700; border-radius: 6px;
            font-style: normal; border: 1px solid #fecaca;
        }

        .panel-heading {
            font-size: 13px; font-weight: 800; color: #1e293b;
            text-transform: uppercase; letter-spacing: 1px;
            display: flex; align-items: center; gap: 10px;
            padding: 12px 16px; border-radius: 12px; background: #f8fafc;
            cursor: pointer; transition: all 0.2s; border: 1px solid #e2e8f0;
        }
        .panel-heading:hover { background: #eff6ff; border-color: var(--primary); color: var(--primary); }
        .panel-heading span.material-icons-round { color: var(--primary); font-size: 20px; transition: transform 0.3s; }
        
        details[open] .panel-heading span.material-icons-round.chevron { transform: rotate(180deg); }
        details summary { list-style: none; outline: none; }
        details summary::-webkit-details-marker { display: none; }

        .analytics-list { display: flex; flex-direction: column; gap: 8px; padding-top: 12px; }
        .analytics-item {
            padding: 12px 16px; border-radius: 12px;
            background: white; border: 1px solid rgba(226, 232, 240, 0.5);
            display: flex; justify-content: space-between; align-items: center;
            transition: all 0.2s;
        }
        .analytics-item:hover { border-color: var(--primary); transform: translateX(4px); }
        .analytics-item .name { font-size: 12px; font-weight: 700; color: #475569; }
        .analytics-item .value { font-size: 13px; font-weight: 800; color: #1e293b; text-align: right; }
        .analytics-item .sub { font-size: 10px; color: #94a3b8; font-weight: 600; }

        .top-5-badge {
            background: #fff7ed; color: #ea580c; border: 1px solid #ffedd5;
            padding: 2px 8px; border-radius: 50px; font-size: 9px; font-weight: 800;
        }

        .dash-footer {
            padding: 12px 30px; background: white; border-top: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center;
        }

        .pagination-controls { display: flex; align-items: center; gap: 8px; }
        .pagination-btn {
            width: 34px; height: 34px; border-radius: 8px; border: 1.5px solid #e2e8f0;
            background: white; color: #1e293b; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
        }
        .pagination-btn:hover:not(:disabled) { background: #eff6ff; border-color: var(--primary); color: var(--primary); }
        .pagination-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .pagination-info { font-weight: 700; color: #1e293b; min-width: 80px; text-align: center; font-size: 12px; }
        .rows-per-page { 
            padding: 6px 10px; border-radius: 8px; border: 1.5px solid #e2e8f0; 
            font-size: 12px; font-weight: 700; outline: none; cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 1200px) {
            .dash-layout { grid-template-columns: 300px 1fr; }
        }

        @media (max-width: 992px) {
            .dash-layout { grid-template-columns: 1fr; }
            .dash-sidebar { 
                position: fixed; inset: 0; z-index: 8500; transform: translateX(-100%);
                transition: transform 0.3s ease; width: 320px; box-shadow: 20px 0 50px rgba(0,0,0,0.1);
            }
            .dash-sidebar.active { transform: translateX(0); }
        }

        @media (max-width: 768px) {
            .dashboard-header { padding: 12px 16px; flex-wrap: wrap; gap: 10px; }
            .dashboard-header h2 { font-size: 16px; }
            .dashboard-stats-grid { grid-template-columns: 1fr; gap: 8px; padding: 16px 20px; }
            .dash-filters { padding: 16px 20px; gap: 10px; }
            .dash-filter-item { min-width: 100%; }
            .dash-footer { flex-direction: column; gap: 16px; align-items: stretch; text-align: center; }
            .pagination-controls { justify-content: center; }
            .paid-table th, .paid-table td { font-size: 11px; padding: 10px 8px; }
            .paid-table-container { -webkit-overflow-scrolling: touch; }
            
            .desktop-only { display: none; }
            
            /* Sticky Column for Survey ID on mobile */
            .paid-table th:nth-child(2), .paid-table td:nth-child(2) {
                position: sticky; left: 0; background: white; z-index: 5;
                box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            }
            .paid-table th:nth-child(2) { z-index: 15; background: #f8fafc; }
        }
        
        .all-records-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white !important; font-weight: 800; padding: 0 20px;
            font-size: 12px; height: 42px; border-radius: 12px;
            display: flex; align-items: center; gap: 10px;
            border: none; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
            cursor: pointer; transition: all 0.2s;
        }
        .all-records-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4); }
        .all-records-btn:active { transform: translateY(0); }
        .all-records-btn.active { 
            background: #1e293b !important; 
            border: 2px solid #3b82f6 !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .paid-deleted-id { background: #fee2e2; color: #991b1b; padding: 2px 6px; border-radius: 4px; font-weight: 800; font-size: 10px; }

        /* Universal Search UI (v6.0) */
        #modal-search {
            display:none; position:fixed; inset:0; background:rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(8px); z-index:11000; align-items:flex-start; justify-content:center; padding-top: 80px;
        }
        .search-container {
            background: rgba(255, 255, 255, 0.95); width: 100%; max-width: 600px;
            border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex; flex-direction: column; max-height: 70vh; margin: 0 20px;
        }
        .search-input-wrapper {
            padding: 20px; border-bottom: 1px solid #f1f5f9; background: white;
            display: flex; align-items: center; gap: 12px;
        }
        #universal-search-input {
            flex: 1; border: none; font-size: 18px; font-weight: 600; color: var(--text); outline: none; background: transparent;
        }
        .search-results { flex: 1; overflow-y: auto; padding: 12px; }
        .search-item {
            padding: 12px 16px; border-radius: 12px; cursor: pointer; transition: all 0.2s;
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;
        }
        .search-item:hover { background: #f1f5f9; }
        .search-item-main { display: flex; flex-direction: column; gap: 2px; }
        .search-item-title { font-weight: 700; color: var(--primary); font-size: 14px; }
        .search-item-sub { font-size: 12px; color: #64748b; font-weight: 500; }
        .search-item-meta { font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; }
        .search-badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 800; background: #f1f5f9; color: #64748b; }
        </style>
</head>
<body>

<div id="sidebar">
    <!-- Compact Header -->
    <div class="sidebar-header-padding" style="padding: 12px 16px 4px 16px; border-bottom: 1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
        <div>
            <div style="font-weight: 700; font-size: 16px;">Field Staff Pro</div>
            <div style="font-size: 10px; color: #64748b; font-weight: 600; margin-top:2px;">
                Updated: 01-Jan 06:00 PM 
                <span style="color:var(--primary); margin-left:4px;">[Rev. 1228.2220]</span>
            </div>
        </div>
        
        <div style="text-align: right;">
            <div id="zoom-level-text" style="font-size: 12px; color: #64748b; font-weight: 500;">Z: 13</div>
            <div style="font-size: 10px; color: #94a3b8; font-weight: 500;">Kashif Khalil <span style="font-size: 9px;">â„¢</span></div>
        </div>
        
        <button class="mobile-only" onclick="Sidebar.toggle()" style="background:none; border:none; display:none; position:absolute; top:16px; right:16px;"><span class="material-icons-round">close</span></button>
    </div>
    
    <div id="sidebar-scroll" style="flex:1; overflow-y:auto; overflow-x: hidden; padding-bottom: 20px;">
        <div class="filters" style="padding: 8px var(--spacer) 80px var(--spacer);">
            <div class="filter-group collapsed">
                <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                    <span class="material-icons-round" style="color:var(--primary); font-size:20px;">public</span>
                    <span class="filter-label" id="lbl-dist" style="flex:1">Districts</span>
                    <div class="filter-actions" style="border:none; padding:0; margin-right:8px;">
                        <button class="select-all-btn" onclick="event.stopPropagation(); App.toggleAll('f-dist', true)">All</button>
                        <button class="select-all-btn unselect" onclick="event.stopPropagation(); App.toggleAll('f-dist', false)">None</button>
                    </div>
                    <div class="selection-badge" id="badge-f-dist" style="display:none">0</div>
                    <button class="toggle-group-btn" style="border:none; background:none; padding:0; margin-left:8px;">
                        <i class="material-icons-round">expand_less</i>
                    </button>
                </div>
                <div id="f-dist" class="multi-select-container"></div>
            </div>
            <div class="filter-group collapsed">
                <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                    <span class="material-icons-round" style="color:var(--primary); font-size:20px;">location_city</span>
                    <span class="filter-label" id="lbl-tehsil" style="flex:1">Tehsils</span>
                    <div class="filter-actions" style="border:none; padding:0; margin-right:8px;">
                        <button class="select-all-btn" onclick="event.stopPropagation(); App.toggleAll('f-tehsil', true)">All</button>
                        <button class="select-all-btn unselect" onclick="event.stopPropagation(); App.toggleAll('f-tehsil', false)">None</button>
                    </div>
                    <div class="selection-badge" id="badge-f-tehsil" style="display:none">0</div>
                    <button class="toggle-group-btn" style="border:none; background:none; padding:0; margin-left:8px;">
                        <i class="material-icons-round">expand_more</i>
                    </button>
                </div>
                <div id="f-tehsil" class="multi-select-container"></div>
            </div>
            <div class="filter-group collapsed">
                <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                    <span class="material-icons-round" style="color:var(--primary); font-size:20px;">map</span>
                    <span class="filter-label" id="lbl-mc" style="flex:1">MC/UC Areas</span>
                    <div class="filter-actions" style="border:none; padding:0; margin-right:8px;">
                        <button class="select-all-btn" onclick="event.stopPropagation(); App.toggleAll('f-mc', true)">All</button>
                        <button class="select-all-btn unselect" onclick="event.stopPropagation(); App.toggleAll('f-mc', false)">None</button>
                    </div>
                    <div class="selection-badge" id="badge-f-mc" style="display:none">0</div>
                    <button class="toggle-group-btn" style="border:none; background:none; padding:0; margin-left:8px;">
                        <i class="material-icons-round">expand_more</i>
                    </button>
                </div>
                <div id="f-mc" class="multi-select-container"></div>
            </div>
            <div class="filter-group collapsed">
                <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                    <span class="material-icons-round" style="color:var(--primary); font-size:20px;">calendar_month</span>
                    <span class="filter-label" style="flex:1">Date Range</span>
                    <button class="select-all-btn unselect" onclick="event.stopPropagation(); App.clearDates()" style="margin-left:auto; margin-right:8px;">Clear</button>
                    <button class="toggle-group-btn" style="border:none; background:none; padding:0;">
                        <i class="material-icons-round">expand_more</i>
                    </button>
                </div>
                <div class="filter-content" style="padding: 12px 16px; display:flex; gap:12px;">
                    <div style="flex:1">
                        <input type="text" id="f-start" class="filter-select" placeholder="Start Date" style="padding:10px; border-radius:8px; border:1px solid #e2e8f0; font-size:13px; font-weight:500; width:100%;">
                    </div>
                    <div style="flex:1">
                        <input type="text" id="f-end" class="filter-select" placeholder="End Date" style="padding:10px; border-radius:8px; border:1px solid #e2e8f0; font-size:13px; font-weight:500; width:100%;">
                    </div>
                </div>
            </div>

            <!-- Payment Filter -->
            <div class="filter-group collapsed">
                <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                    <span class="material-icons-round" style="color:var(--primary); font-size:20px;">payments</span>
                    <span class="filter-label" id="lbl-pay" style="flex:1">Payment</span>
                    <div class="filter-actions" style="border:none; padding:0; margin-right:8px;">
                        <button class="select-all-btn" onclick="event.stopPropagation(); App.toggleAll('f-pay', true)">All</button>
                        <button class="select-all-btn unselect" onclick="event.stopPropagation(); App.toggleAll('f-pay', false)">None</button>
                    </div>
                    <div class="selection-badge" id="badge-f-pay" style="display:none">0</div>
                    <button class="toggle-group-btn" style="border:none; background:none; padding:0; margin-left:8px;">
                        <i class="material-icons-round">expand_more</i>
                    </button>
                </div>
                <div id="f-pay" class="multi-select-container" style="padding: 12px 16px;">
                    <div class="multi-option" data-value="paid" onclick="App.handleMultiClick(event, 'f-pay', 'apply')">
                        <input type="checkbox" onchange="App.handleMultiChange(event, 'f-pay', 'apply')">
                        <span class="pill paid">Paid</span>
                    </div>
                    <div class="multi-option" data-value="unpaid" onclick="App.handleMultiClick(event, 'f-pay', 'apply')">
                        <input type="checkbox" onchange="App.handleMultiChange(event, 'f-pay', 'apply')">
                        <span class="pill unpaid">Unpaid</span>
                    </div>
                    <div class="multi-option" data-value="not-billed" onclick="App.handleMultiClick(event, 'f-pay', 'apply')">
                        <input type="checkbox" onchange="App.handleMultiChange(event, 'f-pay', 'apply')">
                        <span class="pill not-billed">Not Billed</span>
                    </div>
                </div>
            </div>

            <!-- Cloud Sync Filter -->
            <div class="filter-group collapsed">
                <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                    <span class="material-icons-round" style="color:#10b981; font-size:20px;">cloud_sync</span>
                    <span class="filter-label" id="lbl-drive" style="flex:1">Drive Sync</span>
                    <button class="select-all-btn unselect" onclick="event.stopPropagation(); document.getElementById('f-drive-only').checked=false; App.handleMultiChange({target:document.getElementById('f-drive-only')}, 'f-drive', 'apply')" style="margin-left:auto; margin-right:8px;">Clear</button>
                    <div class="selection-badge" id="badge-f-drive" style="display:none; margin-left:0; margin-right:8px;">0</div>
                    <button class="toggle-group-btn" style="border:none; background:none; padding:0;">
                        <i class="material-icons-round">expand_more</i>
                    </button>
                </div>
                <div id="f-drive" class="multi-select-container" style="padding: 12px 16px;">
                    <div class="multi-option" onclick="App.handleMultiClick(event, 'f-drive', 'apply')">
                        <input type="checkbox" id="f-drive-only" onchange="App.handleMultiChange(event, 'f-drive', 'apply')">
                        <span style="font-weight:600; color:#059669;">Show drive images only</span>
                    </div>
                </div>
            </div>

            <!-- Quick Categories -->
            <div class="filter-group collapsed">
                <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                    <span class="material-icons-round" style="color:#8b5cf6; font-size:20px;">category</span>
                    <span class="filter-label" id="lbl-quick" style="flex:1">Categories</span>
                    <div class="filter-actions" style="border:none; padding:0; margin-right:8px;">
                        <button class="select-all-btn" onclick="event.stopPropagation(); App.toggleAll('f-quick', true)">All</button>
                        <button class="select-all-btn unselect" onclick="event.stopPropagation(); App.toggleAll('f-quick', false)">None</button>
                    </div>
                    <div class="selection-badge" id="badge-f-quick" style="display:none">0</div>
                    <button class="toggle-group-btn" style="border:none; background:none; padding:0; margin-left:8px;">
                        <i class="material-icons-round">expand_more</i>
                    </button>
                </div>
                <div id="f-quick" class="filter-content multi-select-container" style="padding: 12px 16px;">
                    <div class="multi-option selected" data-value="urban" onclick="App.toggleQuickFilter('urban', event)">
                        <input type="checkbox" checked id="q-urban"> <span>Urban</span>
                    </div>
                    <div class="multi-option selected" data-value="rural" onclick="App.toggleQuickFilter('rural', event)">
                        <input type="checkbox" checked id="q-rural"> <span>Rural</span>
                    </div>
                    <div class="multi-option selected" data-value="domestic" onclick="App.toggleQuickFilter('domestic', event)">
                        <input type="checkbox" checked id="q-domestic"> <span>Domestic</span>
                    </div>
                    <div class="multi-option selected" data-value="commercial" onclick="App.toggleQuickFilter('commercial', event)">
                        <input type="checkbox" checked id="q-commercial"> <span>Commercial</span>
                    </div>
                </div>
            </div>

            <!-- Tools: Bills -->
            <div class="filter-group collapsed">
                <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                    <span class="material-icons-round" style="color:#22c55e; font-size:20px;">payments</span>
                    <span class="filter-label">Bills</span>
                    <span class="selection-badge" id="badge-paid-count" style="display:none">0</span>
                    <button class="toggle-group-btn" style="border:none; background:none; padding:0; margin-left:8px;">
                        <i class="material-icons-round">expand_more</i>
                    </button>
                </div>
                <div class="filter-content" style="padding: 4px 12px 12px 12px; display:flex; flex-direction:column; gap:4px;">
                    <div class="nested-content" style="display:flex; flex-direction:column; gap:6px;">
                        <div class="sub-tool-item" onclick="PaidBills.open()">
                            <span class="material-icons-round">dashboard</span>
                            <span>Dashboard</span>
                        </div>
                        <div class="sub-tool-item" onclick="BillVerifier.open()">
                            <span class="material-icons-round">verified_user</span>
                            <span>Verify Bill</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tools: List View -->
            <div class="filter-group collapsed">
                <div class="panel-header-premium" onclick="ViewSwitcher.toList()">
                    <span class="material-icons-round" style="color:#06b6d4; font-size:20px;">view_list</span>
                    <span class="filter-label">List View</span>
                    <span class="material-icons-round" style="font-size:18px; color:#94a3b8; margin-left:auto;">chevron_right</span>
                </div>
            </div>

            <!-- Tools: Staff Report -->
            <div class="filter-group collapsed">
                <div class="panel-header-premium" onclick="App.toggleFilterGroup(this)">
                    <span class="material-icons-round" style="color:var(--primary); font-size:20px;">assignment_ind</span>
                    <span class="filter-label">Staff Report Section</span>
                    <button class="toggle-group-btn" style="border:none; background:none; padding:0; margin-left:8px;">
                        <i class="material-icons-round">expand_more</i>
                    </button>
                </div>
                <div class="filter-content" style="padding: 4px 12px 12px 12px;">
                    <div class="nested-content" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                        <div class="sub-tool-item" onclick="Stats.open()" style="background:#f8fafc; border:1px solid #e2e8f0; justify-content:center; flex-direction:column; gap:4px; padding:12px;">
                            <span class="material-icons-round" style="color:#f59e0b;">leaderboard</span>
                            <span style="font-size:10px;">Leaderboard</span>
                        </div>
                        <div class="sub-tool-item" onclick="PerformanceLog.open()" style="background:#f8fafc; border:1px solid #e2e8f0; justify-content:center; flex-direction:column; gap:4px; padding:12px;">
                            <span class="material-icons-round" style="color:#8b5cf6;">assignment_turned_in</span>
                            <span style="font-size:10px;">Performance</span>
                        </div>
                    </div>
                </div>
            </div>

            </div>
        </div>
    
    <!-- Live Totals badge (Repositioned above footer) -->
    <div class="stat-badge">
        <small id="stat-label" style="font-weight:700; color:#64748b; text-transform:uppercase; font-size:9px;">Live Survey Data</small>
        <span id="stat-count" style="font-weight:800; color:var(--primary); font-size:14px;">0</span>
    </div>
    
    <!-- Fixed Sidebar Footer -->
    <div class="sidebar-footer">
        <div class="footer-btn apply" onclick="App.apply()">
            <span class="material-icons-round">done</span> Apply
        </div>
        <div class="footer-btn today" onclick="App.setToday()">
            <span class="material-icons-round">today</span> Today
        </div>
        <div class="footer-btn reset" onclick="App.resetFilters()">
            <span class="material-icons-round">refresh</span> Reset
        </div>
    </div>


</div>

<div id="main-stage">
    <button id="sidebar-toggle" onclick="Sidebar.toggleDesktop()" title="Toggle Sidebar">
        <i class="material-icons-round">keyboard_arrow_left</i>
    </button>
    <div id="info-card" class="minimized">
         <!-- Populated by JS -->
    </div>
    <div id="map-container">
        <div id="map"></div>
        
        <div class="map-controls">
            <div id="extra-ctrls" class="control-group">
                <button class="float-btn" onclick="Stats.open()" title="Leaderboard">
                    <span class="material-icons-round" style="color:#f59e0b">leaderboard</span>
                </button>
                <button class="float-btn" onclick="PerformanceLog.open()" title="Performance">
                    <span class="material-icons-round" style="color:#8b5cf6">assignment_turned_in</span>
                </button>
                <button class="float-btn" onclick="ViewSwitcher.toList()" title="List View">
                    <span class="material-icons-round" style="color:#06b6d4">view_list</span>
                </button>
                <button class="float-btn" onclick="UniversalSearch.open()" title="Universal Search" style="background:var(--primary); color:white;">
                    <span class="material-icons-round">search</span>
                </button>
                <button class="float-btn" onclick="App.toggleLayer()" title="Toggle Satellite">
                    <span class="material-icons-round" id="layer-icon">satellite_alt</span>
                </button>
                <button class="float-btn" onclick="State.map.zoomIn()" title="Zoom In">
                    <span class="material-icons-round">add</span>
                </button>
                <button class="float-btn" onclick="State.map.zoomOut()" title="Zoom Out">
                    <span class="material-icons-round">remove</span>
                </button>
                <button class="float-btn" onclick="Settings.open()" title="Settings">
                    <span class="material-icons-round" style="color:#10b981">settings</span>
                </button>
                <button class="float-btn" onclick="Sidebar.toggle()" title="Menu">
                    <span class="material-icons-round">menu</span>
                </button>
            </div>
            
            <button class="float-btn primary" onclick="App.toggleControls()" id="toggle-ctrls">
                <span class="material-icons-round">keyboard_arrow_down</span>
            </button>
        </div>
    </div>

    <!-- Persistent List View -->
    <div id="list-view-stage">
        <div class="list-nav">
            <button onclick="State.originView === 'dashboard' ? ViewSwitcher.toDashboard() : ViewSwitcher.toMap()" class="gal-btn" style="background:#f1f5f9; color:var(--text);"><span class="material-icons-round">arrow_back</span></button>
            <div style="font-weight:700">Record <span id="lv-idx">1</span> of <span id="lv-total">0</span></div>
            <div style="display:flex; gap:8px;">
                <button onclick="ListView.prev()" class="gal-btn" style="background:#f1f5f9; color:var(--text);"><span class="material-icons-round">chevron_left</span></button>
                <button onclick="ListView.next()" class="gal-btn" style="background:#f1f5f9; color:var(--text);"><span class="material-icons-round">chevron_right</span></button>
            </div>
        </div>
        <div class="record-card-container" style="flex:1; position:relative; overflow:hidden; display:flex; flex-direction:column;">
            <div id="lv-search-container" style="position:relative; margin: 12px auto; width: 96%; max-width: 560px; z-index:1002;"></div>
            <div id="lv-content" class="record-card"></div>
        </div>
    </div>
    </div>
    <!-- Modals & Overlays -->
<div id="modal-stats" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:6000; align-items:center; justify-content:center; padding:20px;">
    <div style="background:white; border-radius:16px; width:100%; max-width:850px; height:90vh; display:flex; flex-direction:column;">
        <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0" id="stats-title">Staff Workflow Leaderboard</h3>
            <button onclick="Stats.close()" style="background:none; border:none; cursor:pointer;"><span class="material-icons-round">close</span></button>
        </div>
        <div id="stats-body" class="stats-table-container" style="flex:1; overflow-y:auto; padding:0;"></div>
    </div>
</div>

<div id="modal-verify-bill" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10000; align-items:center; justify-content:center; padding:10px;">
    <div style="background:white; border-radius:16px; width:100%; max-width:1000px; height:90vh; display:flex; flex-direction:column; box-shadow: 0 20px 50px rgba(0,0,0,0.3); overflow:hidden;">
        <div style="padding:16px 24px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center; background:#fafafa;">
            <div style="display:flex; align-items:center; gap:12px;">
                <span class="material-icons-round" style="color:var(--primary); font-size:28px;">verified_user</span>
                <div>
                    <h3 style="margin:0; font-size:18px;">Verify Bill Status</h3>
                    <div id="verify-psid-label" style="font-size:11px; color:#64748b; font-weight:700;">EXTERNAL: SUTHRA PUNJAB</div>
                </div>
            </div>
            <button onclick="BillVerifier.close()" style="background:#f1f5f9; border:none; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; cursor:pointer;"><span class="material-icons-round">close</span></button>
        </div>
        <div style="flex:1; background:#f8fafc; position:relative;">
            <div id="verify-loader" style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; background:white; z-index:1;">
                <span class="material-icons-round rotate" style="font-size:48px; color:var(--primary); margin-bottom:12px;">sync</span>
                <div style="font-weight:700; color:#64748b;">Loading Verification Portal...</div>
            </div>
            <iframe id="verify-iframe" src="" style="width:100%; height:100%; border:none;" onload="document.getElementById('verify-loader').style.display='none'"></iframe>
        </div>
    </div>
</div>

<!-- Advanced Paid Dashboard Stage (v7.2.1) -->
<div id="paid-dashboard-stage">
    <div class="dashboard-header">
        <div style="display:flex; align-items:center; gap:16px;">
            <button onclick="PaidBills.toggleSidebar()" class="gal-btn" style="background:#f1f5f9; color:#64748b; width:40px; height:40px; border-radius:10px;"><span class="material-icons-round">menu_open</span></button>
            <div style="background:#eff6ff; color:#2563eb; width:42px; height:42px; border-radius:10px; display:flex; align-items:center; justify-content:center;">
                <span class="material-icons-round" style="font-size:24px;">analytics</span>
            </div>
            <div>
                <h2 style="margin:0; font-size:18px;">Paid Analytics Hub</h2>
                <div style="font-size:10px; color:#64748b; font-weight:700; margin-top:2px;">REAL-TIME RECOVERY INSIGHTS</div>
            </div>
        </div>
        <div style="display:flex; gap:12px;">
            <button onclick="PaidBills.setType('domestic')" class="all-records-btn dash-type-btn" data-type="domestic" style="background:#0ea5e9; box-shadow:0 4px 12px rgba(14,165,233,0.3);">
                <span class="material-icons-round">home</span> 
                <span class="desktop-only">DOMESTIC</span>
            </button>
            <button onclick="PaidBills.setType('commercial')" class="all-records-btn dash-type-btn" data-type="commercial" style="background:#f59e0b; box-shadow:0 4px 12px rgba(245,158,11,0.3);">
                <span class="material-icons-round">business</span> 
                <span class="desktop-only">COMMERCIAL</span>
            </button>
            <button id="pb-all-records-btn" onclick="PaidBills.reset()" class="all-records-btn active">
                <span class="material-icons-round" style="font-size:20px;">history</span> 
                <span class="desktop-only">ALL RECORDS</span>
            </button>
            <button onclick="PaidBills.close()" class="gal-btn" style="background:#1e293b; color:white; width:40px; height:40px; border-radius:10px;"><span class="material-icons-round">close</span></button>
        </div>
    </div>

    <div class="dash-layout" id="dash-layout">
        <!-- Unified Dashboard Sidebar -->
        <div class="dash-sidebar" id="dash-sidebar">
            <details open style="margin-bottom:16px;">
                <summary>
                    <div class="panel-heading">
                        <span class="material-icons-round">location_on</span>
                        <span style="flex:1">Area Distribution</span>
                        <span class="material-icons-round chevron">expand_more</span>
                    </div>
                </summary>
                <div id="pb-uc-summary" class="analytics-list">
                    <!-- Dynamic Content -->
                </div>
            </details>
            
            <details open>
                <summary>
                    <div class="panel-heading">
                        <span class="material-icons-round">pie_chart</span>
                        <span style="flex:1">Categorical Split</span>
                        <span class="material-icons-round chevron">expand_more</span>
                    </div>
                </summary>
                <div id="pb-category-summary" class="analytics-list">
                    <!-- Dynamic Content -->
                </div>
            </details>
        </div>

        <!-- Main Content Central Pane -->
        <div class="dash-main-content">
            <div class="dashboard-stats-grid">
                <div class="dash-stat-card">
                    <div class="dash-stat-icon" style="background: #eff6ff; color: #2563eb;">
                        <span class="material-icons-round">payments</span>
                    </div>
                    <div class="dash-stat-info">
                        <div class="dash-stat-label">Filtered Amount</div>
                        <div id="pb-total-amount" class="dash-stat-value">Rs. 0</div>
                    </div>
                </div>
                <div class="dash-stat-card">
                    <div class="dash-stat-icon" style="background: #edfcf2; color: #059669;">
                        <span class="material-icons-round">history_edu</span>
                    </div>
                    <div class="dash-stat-info">
                        <div class="dash-stat-label">Bills Found</div>
                        <div id="pb-total-count" class="dash-stat-value">0</div>
                    </div>
                </div>
                <div class="dash-stat-card">
                    <div class="dash-stat-icon" style="background: #fff7ed; color: #ea580c;">
                        <span class="material-icons-round">query_stats</span>
                    </div>
                    <div class="dash-stat-info">
                        <div class="dash-stat-label">Avg Recovery</div>
                        <div id="pb-avg-amount" class="dash-stat-value">Rs. 0</div>
                    </div>
                </div>
            </div>

            <div class="dash-filters">
                <div class="dash-filter-item">
                    <label>Date From</label>
                    <input type="text" id="pb-date-start" placeholder="Start Date" onchange="PaidBills.render()">
                </div>
                <div class="dash-filter-item">
                    <label>Date To</label>
                    <input type="text" id="pb-date-end" placeholder="End Date" onchange="PaidBills.render()">
                </div>
                <div class="dash-filter-item">
                    <label>City / Office</label>
                    <select id="pb-city" onchange="PaidBills.render()"></select>
                </div>
                <div class="dash-filter-item">
                    <label>Category</label>
                    <select id="pb-type" onchange="PaidBills.render()">
                        <option value="all">All Categories</option>
                    </select>
                </div>
                <div class="dash-filter-item">
                    <label>ID Status</label>
                    <select id="pb-id-status" onchange="PaidBills.render()">
                        <option value="all">Global (All IDs)</option>
                        <option value="deleted">Deleted IDs Only</option>
                        <option value="active">Active IDs Only</option>
                    </select>
                </div>
                <div class="dash-filter-item" style="flex:0 0 auto;">
                    <button onclick="PaidBills.render()" class="apply-btn" style="height:42px; background:#16a34a; border:none; box-shadow:0 4px 12px rgba(22,163,74,0.1); padding:0 20px; border-radius:10px; display:flex; align-items:center; gap:8px;">
                        <span class="material-icons-round" style="font-size:20px;">sync</span>
                        <span style="font-weight:700">Refresh</span>
                    </button>
                </div>
            </div>

            <div class="paid-table-container">
                <table class="paid-table">
                    <thead>
                        <tr>
                            <th>Sr#</th>
                            <th>Survey ID</th>
                            <th>PSID</th>
                            <th>City</th>
                            <th>Month</th>
                            <th>Office</th>
                            <th>UC</th>
                            <th>Category</th>
                            <th>Due Amt</th>
                            <th>Fine</th>
                            <th>Channel</th>
                            <th style="min-width:100px">Paid Date</th>
                            <th>Paid Amt</th>
                        </tr>
                    </thead>
                    <tbody id="pb-table-body"></tbody>
                </table>
            </div>

            <div class="dash-footer">
                <div style="display:flex; align-items:center; gap:16px;">
                    <span>Rows: <select id="pb-rows-per-page" class="rows-per-page" onchange="PaidBills.setRows(this.value)">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select></span>
                    <span id="pb-record-range">Showing 0-0</span>
                </div>
                <div class="pagination-controls">
                    <button onclick="PaidBills.changePage(-1)" id="pb-prev" class="pagination-btn"><span class="material-icons-round">chevron_left</span></button>
                    <div id="pb-page-info" class="pagination-info">Page 1 of 1</div>
                    <button onclick="PaidBills.changePage(1)" id="pb-next" class="pagination-btn"><span class="material-icons-round">chevron_right</span></button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Universal Search Modal (v6.0) -->
<div id="modal-search" onclick="if(event.target===this) UniversalSearch.close()">
    <div class="search-container">
        <div class="search-input-wrapper">
            <span class="material-icons-round" style="color:var(--primary); font-size:28px;">search</span>
            <input type="text" id="universal-search-input" placeholder="Search Survey ID, PSID, Name, Address..." oninput="UniversalSearch.handleInput(this.value)">
            <button onclick="UniversalSearch.close()" style="background:#f1f5f9; border:none; border-radius:50%; width:36px; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                <span class="material-icons-round" style="font-size:20px;">close</span>
            </button>
        </div>
        <div id="search-results-list" class="search-results">
            <div style="text-align:center; padding:40px; color:#94a3b8;">
                <span class="material-icons-round" style="font-size:48px; opacity:0.3; margin-bottom:8px;">manage_search</span>
                <div>Type to search across all records...</div>
            </div>
        </div>
        <div style="padding:10px 20px; background:#f8fafc; border-top:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center;">
            <div id="search-count" style="font-size:11px; font-weight:700; color:#94a3b8;">0 RECORDS FOUND</div>
            <div style="font-size:10px; color:#cbd5e1; font-weight:500;">PRESS ESC TO CLOSE</div>
        </div>
    </div>
</div>

<div id="modal-log" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:6500; align-items:center; justify-content:center; padding:20px;">
    <div style="background:white; border-radius:16px; width:100%; max-width:950px; max-height:90vh; display:flex; flex-direction:column; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
        <div class="modal-header" style="padding:24px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center; background: #fafafa; border-radius: 16px 16px 0 0;">
            <div style="display:flex; align-items:center; gap:12px;">
                <span class="material-icons-round" style="color:#8b5cf6; font-size:32px;">assignment_turned_in</span>
                <div>
                    <h3 style="margin:0; font-size: 20px;">Performance</h3>
                    <div style="display:flex; align-items:center; gap:10px; margin-top:4px;">
                        <small id="log-subtitle" style="color:#64748b; font-weight:600;"></small>
                        <div style="height:12px; width:1px; background:#e2e8f0;"></div>
                        <small id="data-start" style="color:#94a3b8; font-size:11px;"></small>
                    </div>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
                <div style="display:flex; align-items:center; gap:8px; background:#fff; border:1px solid #e2e8f0; padding:4px 12px; border-radius:8px;">
                    <small style="font-weight:700; color:#64748b;">Attendance From:</small>
                    <input type="date" id="att-start-date" onchange="PerformanceLog.updateDate(this.value)" style="border:none; font-family:inherit; font-weight:600; color:var(--primary); outline:none; cursor:pointer;">
                </div>
                <button onclick="PerformanceLog.close()" style="background:#f1f5f9; border:none; border-radius: 50%; width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; cursor:pointer;"><span class="material-icons-round">close</span></button>
            </div>
        </div>
        <div id="log-body" class="stats-table-container" style="flex:1; overflow-y:auto; padding:0;"></div>
    </div>
</div>

<div id="gallery" class="gallery-overlay">
    <div class="gal-header" style="padding: 20px 30px; display: flex; justify-content: flex-end; align-items: center; gap: 24px;">
        <div id="gal-counter" style="color:white; font-weight:700; background:rgba(255,255,255,0.1); padding:8px 18px; border-radius:30px; font-size:15px; backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.15); box-shadow: 0 4px 15px rgba(0,0,0,0.2);">1 / 1</div>
        <button onclick="Gallery.close()" style="background:none; border:none; color:white; cursor:pointer; display:flex; align-items:center; opacity:0.8; transition:opacity 0.2s;"><span class="material-icons-round" style="font-size:42px">close</span></button>
    </div>
    <div class="gal-viewport" id="gal-vp">
        <img id="gal-img" class="gal-img" style="cursor: default;">
    </div>
    <div class="gal-controls">
        <button class="gal-btn" onclick="Gallery.rotate()" title="Rotate (R)"><span class="material-icons-round">rotate_right</span></button>
        <button class="gal-btn" onclick="Gallery.zoomOut()" title="Zoom Out (-)"><span class="material-icons-round">remove</span></button>
        <button class="gal-btn" onclick="Gallery.reset()" title="Reset Screen"><span class="material-icons-round">refresh</span></button>
        <button class="gal-btn" onclick="Gallery.zoomIn()" title="Zoom In (+)"><span class="material-icons-round">add</span></button>
    </div>
</div>

<input type="file" id="drive-upload-input" multiple accept="image/*" style="display:none;" onchange="DriveSync.handleFiles(this.files)">

<div id="modal-settings" onclick="if(event.target===this) Settings.close()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:7000; align-items:center; justify-content:center; padding:20px; backdrop-filter: blur(4px);">
    <div style="background:white; border-radius:16px; width:100%; max-width:640px; height: 600px; display:flex; flex-direction:column; box-shadow: 0 20px 50px rgba(0,0,0,0.2); overflow: hidden;">
        <div style="padding:20px 24px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center; background: #fafafa;">
            <div style="display:flex; align-items:center; gap:12px;">
                <span class="material-icons-round" style="color:#10b981; font-size:28px;">settings_suggest</span>
                <h3 style="margin:0; font-size: 18px; font-weight: 800; letter-spacing: -0.5px;">Advanced Settings</h3>
            </div>
            <button onclick="Settings.close()" style="background:#f1f5f9; border:none; border-radius: 50%; width: 36px; height: 36px; display:flex; align-items:center; justify-content:center; cursor:pointer; color: #64748b;">
                <span class="material-icons-round" style="font-size: 20px;">close</span>
            </button>
        </div>
        <div id="settings-layers-container" style="flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative;">
             <!-- Populated by JS (Stats, Marker Limit, and KML Tabs) -->
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

        <script>
            // Global Data Placeholders
            window.RAW_DATA = [];
            window.PAID_DATA = [];
            window.HIERARCHY = {};
            window.GEO_LAYERS = {};
            
            async function loadData() {
                const loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'initial-loader';
                loadingOverlay.style.cssText = 'position:fixed; inset:0; background:#fff; z-index:99999; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:sans-serif;';
                loadingOverlay.innerHTML = '<div style="font-size:24px; font-weight:bold; margin-bottom:20px; color:#2563eb;">Loading Map Data...</div><div class="loader" style="width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; animation:spin 1s linear infinite;"></div><div id="loader-status" style="margin-top:20px; color:#64748b;">Initializing...</div><style>@keyframes spin {0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);}}</style>';
                document.body.appendChild(loadingOverlay);
                
                const status = document.getElementById('loader-status');
                
                try {
                    const fetchJSON = async (url, label) => {
                        status.innerText = `Loading ${label}...`;
                        const res = await fetch(url);
                        if(!res.ok) throw new Error(`Failed to load ${label}`);
                        return await res.json();
                    };
                    
                    const [rawData, paidData, hierarchyData, geoLayers] = await Promise.all([
                        fetchJSON('data.json', 'Survey Records'),
                        fetchJSON('paid_data.json', 'Payment Data'),
                        fetchJSON('hierarchy.json', 'Locations'),
                        fetchJSON('geo_layers.json', 'Map Layers')
                    ]);
                    
                    window.RAW_DATA = rawData;
                    window.PAID_DATA = paidData;
                    window.HIERARCHY = hierarchyData;
                    window.GEO_LAYERS = geoLayers;
                    
                    status.innerText = 'Starting Application...';
                    setTimeout(() => {
                        loadingOverlay.remove();
                        if(window.App && window.App.init) {
                            window.App.init();
                        } else {
                            console.error("App.init missing!");
                            alert("Initialization Error: App logic not found.");
                        }
                    }, 500);
                    
                } catch(e) {
                    console.error(e);
                    status.innerText = `Error: ${e.message}`;
                    status.style.color = '#ef4444';
                    status.innerHTML += '<br><button onclick="location.reload()" style="margin-top:10px; padding:8px 16px;">Retry</button>';
                }
            }
            
            // Start Loading immediately
            window.addEventListener('DOMContentLoaded', loadData);
        </script>
        

<script>
    // Safety check for injected data
    if (typeof GEO_LAYERS === 'undefined') window.GEO_LAYERS = {};
    if (typeof RAW_DATA === 'undefined') window.RAW_DATA = [];
    if (typeof PAID_DATA === 'undefined') window.PAID_DATA = [];
    if (typeof HIERARCHY === 'undefined') window.HIERARCHY = {};

    const State = {
        filtered: [],
        availableSurveyors: [], 
        surveyorFilter: [], 
        markers: L.layerGroup(),
        currentIdx: 0,
        map: null,
        markerLimit: 999999,
        payColorMode: false,
        syncedData: {}, // { surveyId: latestTimestamp }
        driveOnlyFilter: false,
        originView: 'map', // Track origin for navigation (map, dashboard)
        quickFilters: { urban: true, rural: true, domestic: true, commercial: true }
    };

    const App = {
        toggleQuickFilter(key, e) {
            if(e && e.target.tagName==='INPUT') return; // Handled by change listener potentially, but better to unify here
            State.quickFilters[key] = !State.quickFilters[key];
            const checkbox = document.getElementById(`q-${key}`);
            if(checkbox) {
                checkbox.checked = State.quickFilters[key];
                checkbox.closest('.multi-option').classList.toggle('selected', State.quickFilters[key]);
            }
            this.apply();
        },

        updateSidebarStatus() {
            // Update selection counts (balloons) in filter headers
            const updates = [
                { id: 'f-dist', badgeId: 'badge-f-dist' },
                { id: 'f-tehsil', badgeId: 'badge-f-tehsil' },
                { id: 'f-mc', badgeId: 'badge-f-mc' },
                { id: 'f-pay', badgeId: 'badge-f-pay' },
                { id: 'f-quick', badgeId: 'badge-f-quick' },
                { id: 'f-drive', badgeId: 'badge-f-drive' }
            ];

            updates.forEach(upd => {
                const badge = document.getElementById(upd.badgeId);
                if(!badge) return;
                
                let selected = 0;
                let total = 0;

                if (upd.id === 'f-quick') {
                    selected = Object.values(State.quickFilters).filter(v => v).length;
                    total = Object.values(State.quickFilters).length;
                } else if (upd.id === 'f-drive') {
                    selected = document.getElementById('f-drive-only').checked ? 1 : 0;
                    total = 1;
                } else {
                    selected = this.getSelected(upd.id).length;
                    total = this.getMultiSelectItems(upd.id).length;
                }
                
                if (selected > 0 && selected < total) {
                    badge.innerText = selected;
                    badge.style.display = 'inline-flex';
                    badge.style.background = '#eff6ff';
                    badge.style.color = '#2563eb';
                    badge.style.borderColor = '#dbeafe';
                } else if (selected === total && total > 0) {
                    badge.innerText = 'All';
                    badge.style.display = 'inline-flex';
                    badge.style.background = '#edfcf2';
                    badge.style.color = '#059669';
                    badge.style.borderColor = '#bbf7d0';
                } else {
                    badge.style.display = 'none';
                }
            });

            // Update Paid History Count
            const paidBadge = document.getElementById('badge-paid-count');
            if(paidBadge && typeof PAID_DATA !== 'undefined') {
                const count = Object.keys(PAID_DATA).length;
                if(count > 0) {
                    paidBadge.innerText = count;
                    paidBadge.style.display = 'inline-flex';
                } else {
                    paidBadge.style.display = 'none';
                }
            }
        },

        init() {
            this.initMap();
            this.initFilters();
            Sidebar.init();
            InfoCard.init();
            this.resetFilters(); // Initial load (Zero markers + Cantonment KML)
            
            // Live Zoom Updates
            State.map.on('zoomend', () => {
                const el = document.getElementById('zoom-level-text');
                if(el) el.innerText = `Z: ${State.map.getZoom()}`;
            });
            // Initial call
            const el = document.getElementById('zoom-level-text');
            if(el) el.innerText = `Z: ${State.map.getZoom()}`;

            // Handle URL Params (QR Code Link)
            setTimeout(() => this.handleUrlParams(), 1000); 

            // Background Fetch Synced Data
            setTimeout(() => DriveSync.fetchAllSyncedData(), 2000);
        },

        handleUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const sid = urlParams.get('sid');
            if (sid) {
                console.log("Found Survey ID in URL:", sid);
                
                // FORCE RESET FILTERS TO "ALL"
                // This ensures we search looking at the entire dataset, not just the default view.
                
                // 1. Select All Districts, Tehsils, MCs
                App.toggleAll('f-dist', true);
                App.toggleAll('f-tehsil', true);
                App.toggleAll('f-mc', true);
                
                // 2. Clear Date Filters
                this.clearDates();
                
                // 3. Apply to update State.filtered
                this.apply();
                
                // Switch to List View
                ViewSwitcher.toList();
                
                // Wait for List to Populate (now with FULL data)
                setTimeout(() => {
                    const searchInput = document.getElementById('lv-search');
                    if(searchInput) {
                        searchInput.value = sid;
                        ListView.render(); // This filters State.filtered by the search term
                        
                        // Auto-select first result if exact match
                        setTimeout(() => {
                             if(State.filtered.length > 0) {
                                  // Find record that exactly matches ID if possible
                                  const record = State.filtered.find(r => r[0].toString() === sid) || State.filtered[0];
                                  
                                  if(record) {
                                      ViewSwitcher.toMap();
                                      State.map.flyTo([record[1], record[2]], 19);
                                      
                                      // Open Popup
                                      setTimeout(() => {
                                          State.markers.eachLayer(layer => {
                                              if(layer.options.id === sid.toString()) {
                                                  layer.openPopup();
                                              }
                                          });
                                      }, 800);
                                  }
                             }
                        }, 200);
                    }
                }, 800);
            }
        },

        resetFilters() {
            State.surveyorFilter = [];
            if(State.fpStart) State.fpStart.clear();
            if(State.fpEnd) State.fpEnd.clear();
            
            // Uncheck All for Payment status
            this.toggleAll('f-pay', false);

            // Reset quick filters to active
            State.quickFilters = { urban: true, rural: true, domestic: true, commercial: true };
            ['urban', 'rural', 'domestic', 'commercial'].forEach(key => {
                const cb = document.getElementById(`q-${key}`);
                if(cb) {
                    cb.checked = true;
                    cb.parentElement.classList.add('selected');
                }
            });
            
            // Standard reset: Re-initialize to defaults (Sargodha City / Cantonment)
            this.initFilters(); 

            // NO MARKERS LOADED (as requested)
            State.markers.clearLayers();
            State.filtered = []; 
            const countEl = document.getElementById('stat-count');
            if(countEl) countEl.innerText = "0 / " + RAW_DATA.length;
            
            // AUTO-ENABLE CANTONOMENT KML (as requested)
            if(typeof LayerManager !== 'undefined' && typeof GEO_LAYERS !== 'undefined') {
                const cantonmentKeys = [];
                for(let city in GEO_LAYERS) {
                    for(let layerName in GEO_LAYERS[city]) {
                        if(layerName.toUpperCase().includes('CANTONMENT')) {
                            cantonmentKeys.push(`${city}|${layerName}`);
                        }
                    }
                }
                if(cantonmentKeys.length > 0) {
                    LayerManager.load(cantonmentKeys);
                }
            }
        },
        
        setToday() {
            const today = new Date();
            if(State.fpStart) State.fpStart.setDate(today, true);
            if(State.fpEnd) State.fpEnd.setDate(today, true);
            // apply is triggered by onChange in flatpickr, but just in case:
            this.apply();
        },

        clearDates() {
            if(State.fpStart) State.fpStart.clear();
            if(State.fpEnd) State.fpEnd.clear();
            this.apply();
        },

        initMap() {
            State.map = L.map('map', { 
                zoomControl: false,
                preferCanvas: false // Fixes white boxes / marker fidelity
            }).setView([32.0836, 72.6711], 13);

            // Create a dedicated pane for KML layers to keep them below markers
            State.map.createPane('kmlPane');
            State.map.getPane('kmlPane').style.zIndex = 350; // Below overlayPane (400)
            // Note: Keep pointer-events active so tooltips work, but since it's lower z-index, markers will take precedence.
            
            State.layers = {
                roads: L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                    maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']
                }),
                sat: L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                    maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']
                })
            };
            
            State.layers.roads.addTo(State.map);
            State.activeLayer = 'roads';
            State.markers.addTo(State.map);
        },

        toggleLayer() {
            const isRoads = State.activeLayer === 'roads';
            State.map.removeLayer(State.layers[State.activeLayer]);
            State.activeLayer = isRoads ? 'sat' : 'roads';
            State.layers[State.activeLayer].addTo(State.map);
            
            document.getElementById('layer-icon').innerText = isRoads ? 'map' : 'satellite_alt';
        },

        toggleControls() {
            const grp = document.getElementById('extra-ctrls');
            const btn = document.getElementById('toggle-ctrls').querySelector('.material-icons-round');
            const isCollapsed = grp.classList.toggle('collapsed');
            btn.innerText = isCollapsed ? 'keyboard_arrow_up' : 'keyboard_arrow_down';
        },

        toggleFilterGroup(el) {
            const group = el.closest('.filter-group');
            const isCollapsing = !group.classList.contains('collapsed');
            
            // Accordion: Collapse all others
            document.querySelectorAll('#sidebar .filter-group').forEach(g => {
                if (g === group) return;
                g.classList.add('collapsed');
                g.classList.remove('active-group');
                const i = g.querySelector('.material-icons-round:last-child, .toggle-group-btn i');
                if(i && (i.innerText === 'expand_less' || i.innerText === 'expand_more')) {
                    i.innerText = 'expand_more';
                }
            });
            
            if (isCollapsing) {
                group.classList.add('collapsed');
                group.classList.remove('active-group');
                const i = group.querySelector('.material-icons-round:last-child, .toggle-group-btn i');
                if(i && (i.innerText === 'expand_less' || i.innerText === 'expand_more')) {
                    i.innerText = 'expand_more';
                }
            } else {
                group.classList.remove('collapsed');
                group.classList.add('active-group');
                const i = group.querySelector('.material-icons-round:last-child, .toggle-group-btn i');
                if(i && (i.innerText === 'expand_less' || i.innerText === 'expand_more')) {
                    i.innerText = 'expand_less';
                }
            }
        },

        initFilters() {
            const dists = Object.keys(HIERARCHY).sort();
            this.renderMultiSelect('f-dist', dists.map(d => ({ v: d, l: d })), 'onDistChange');
            
            // Initial Load Defaults (Sargodha City + Cantonment)
            if(HIERARCHY['SARGODHA']) {
                this.setSelected('f-dist', ['SARGODHA']);
            } else if(dists.length > 0) {
                this.setSelected('f-dist', [dists[0]]);
            }
            
            this.onDistChange();
            
            if(HIERARCHY['SARGODHA']?.['SARGODHA']) {
                this.setSelected('f-tehsil', ['SARGODHA']);
            }
            this.onTehsilChange();

            const mItems = this.getMultiSelectItems('f-mc');
            const targetMC = mItems.find(item => 
                item.value.toUpperCase().includes('CANTONMENT') || 
                item.value.toUpperCase().includes('MC-1') || 
                item.value.toUpperCase().includes('MC 1')
            );
            if(targetMC) {
                this.setSelected('f-mc', [targetMC.value]);
            }

            // Init Flatpickr if not already
            if(!State.fpStart) {
                State.fpStart = flatpickr("#f-start", { onChange: () => this.apply() });
                State.fpEnd = flatpickr("#f-end", { onChange: () => this.apply() });
            }
            this.updateSidebarStatus();
        },

        renderMultiSelect(id, items, onUpdate) {
            const container = document.getElementById(id);
            container.innerHTML = items.map(item => `
                <div class="multi-option" data-value="${item.v}" onclick="App.handleMultiClick(event, '${id}', '${onUpdate}')">
                    <input type="checkbox" ${item.selected ? 'checked' : ''} onchange="App.handleMultiChange(event, '${id}', '${onUpdate}')">
                    <span>${item.l}</span>
                </div>
            `).join('');
        },

        // Dedicated robust MC/UC multi-select using DOM API
        renderMCUCSelect(items) {
            const container = document.getElementById('f-mc');
            container.innerHTML = ''; // Clear existing
            
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'multi-option';
                div.setAttribute('data-value', item.v);
                if(item.selected) div.classList.add('selected');
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = item.selected || false;
                checkbox.addEventListener('change', function() {
                    div.classList.toggle('selected', this.checked);
                });
                
                const span = document.createElement('span');
                span.textContent = item.l;
                
                div.appendChild(checkbox);
                div.appendChild(span);
                
                // Click on row toggles checkbox
                div.addEventListener('click', function(e) {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        div.classList.toggle('selected', checkbox.checked);
                    }
                });
                
                container.appendChild(div);
            });
        },

        // Get selected MC/UC values
        getSelectedMCUC() {
            const container = document.getElementById('f-mc');
            const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => 
                cb.closest('.multi-option').getAttribute('data-value')
            );
        },


        handleMultiClick(e, id, onUpdate) {
            if(e.target.tagName === 'INPUT') return;
            const row = e.currentTarget;
            const cb = row.querySelector('input');
            cb.checked = !cb.checked;
            row.classList.toggle('selected', cb.checked);
            if(onUpdate && App[onUpdate]) App[onUpdate]();
        },

        handleMultiChange(e, id, onUpdate) {
            const row = e.target.closest('.multi-option');
            row.classList.toggle('selected', e.target.checked);
            if(onUpdate && App[onUpdate]) App[onUpdate]();
        },

        toggleAll(id, state) {
            if(id === 'f-quick') {
                Object.keys(State.quickFilters).forEach(key => {
                    State.quickFilters[key] = state;
                });
                // Sync UI
                ['urban', 'rural', 'domestic', 'commercial'].forEach(key => {
                    const cb = document.getElementById(`q-${key}`);
                    if(cb) {
                        cb.checked = state;
                        cb.closest('.multi-option').classList.toggle('selected', state);
                    }
                });
                this.apply();
                return;
            }

            const container = document.getElementById(id);
            const checkboxes = container.querySelectorAll('input');
            checkboxes.forEach(cb => {
                cb.checked = state;
                cb.closest('.multi-option').classList.toggle('selected', state);
            });
            
            if(id === 'f-dist') this.onDistChange();
            else if(id === 'f-tehsil') this.onTehsilChange();
            else if(id === 'f-pay' || id === 'f-drive') this.apply();

            this.updateSidebarStatus();
        },

        getSelected(id) {
            const container = document.getElementById(id);
            return Array.from(container.querySelectorAll('.multi-option'))
                .filter(row => row.querySelector('input').checked)
                .map(row => row.getAttribute('data-value'));
        },

        getMultiSelectItems(id) {
             const container = document.getElementById(id);
             return Array.from(container.querySelectorAll('.multi-option')).map(row => ({
                 value: row.getAttribute('data-value')
             }));
        },

        setSelected(id, values) {
            const container = document.getElementById(id);
            container.querySelectorAll('.multi-option').forEach(row => {
                const val = row.getAttribute('data-value');
                const checked = values.includes(val);
                row.querySelector('input').checked = checked;
                row.classList.toggle('selected', checked);
            });
        },

        onDistChange() {
            const selectedDists = this.getSelected('f-dist');
            let items = [];
            
            selectedDists.forEach(d => {
                const tehsils = Object.keys(HIERARCHY[d] || {}).sort();
                tehsils.forEach(t => {
                    items.push({ v: t, l: `${d} - ${t}` });
                });
            });
            
            this.renderMultiSelect('f-tehsil', items, 'onTehsilChange');
            this.onTehsilChange();
        },

        onTehsilChange() {
            const items = this.getAvailableMCUCs();
            
            // Get CURRENT selections from DOM right before re-rendering
            const currentlySelected = this.getSelectedMCUC();
            
            items.forEach(item => {
                item.selected = currentlySelected.includes(item.v);
            });
            
            this.renderMCUCSelect(items);
            ListView.syncMCUC();
        },

        getAvailableMCUCs() {
            const selectedDists = this.getSelected('f-dist');
            const selectedTehsils = this.getSelected('f-tehsil');
            let items = [];
            
            selectedDists.forEach(d => {
                const distData = HIERARCHY[d] || {};
                selectedTehsils.forEach(t => {
                    const tehsilData = distData[t] || {};
                    for(let m in tehsilData) {
                        items.push({ 
                            v: m, 
                            l: `${t} - ${tehsilData[m].s}`,
                            short: tehsilData[m].s
                        });
                    }
                });
            });
            
            items.sort((a, b) => {
                const aShort = a.short.toUpperCase();
                const bShort = b.short.toUpperCase();
                const aIsMC = aShort.startsWith('MC');
                const bIsMC = bShort.startsWith('MC');
                if(aIsMC && !bIsMC) return -1;
                if(!aIsMC && bIsMC) return 1;
                const aNum = parseInt(aShort.replace(/[^0-9]/g, '')) || 0;
                const bNum = parseInt(bShort.replace(/[^0-9]/g, '')) || 0;
                if(aNum !== bNum) return aNum - bNum;
                return a.l.localeCompare(b.l);
            });
            return items;
        },

        setSurveyorFilter(selectedValues) {
            // selectedValues is an array from multi-select
            State.surveyorFilter = selectedValues.length > 0 ? selectedValues : [];
            this.apply(); 
            // If in list view, re-render implies updating the current view
            if(document.getElementById('list-view-stage').classList.contains('active')) {
                State.currentIdx = 0;
                ListView.render();
            }
        },

        apply(isInitial = false) {
            // If we're in Single ID Mode and this is a manual apply, clear the mode
            if(!isInitial && State.lastView) {
                State.lastView = null;
            }

            const dists = this.getSelected('f-dist');
            const tehsils = this.getSelected('f-tehsil');
            const mcs = this.getSelectedMCUC();
            const payFilters = this.getSelected('f-pay'); // Renamed to avoid conflict with 'pays' in filter logic
            const s = document.getElementById('f-start').value;
            const e = document.getElementById('f-end').value;
            
            const driveOnlyCb = document.getElementById('f-drive-only');
            State.driveOnlyFilter = driveOnlyCb ? driveOnlyCb.checked : false;
            
            // Re-calculate payColorMode based on current selections
            State.payColorMode = payFilters && payFilters.length > 0;

            // 1. Geographical & Payment Filter
            let geoFiltered = RAW_DATA.filter(r => {
                if(dists.length > 0 && !dists.includes(r[10])) return false;
                if(tehsils.length > 0 && !tehsils.includes(r[11])) return false;
                if(mcs.length > 0 && !mcs.includes(r[12])) return false;
                
                // Payment Multi-Select Filter
                const statusA = (r[16] || '').toLowerCase().replace(' ', '-');
                if (payFilters.length > 0 && !payFilters.includes(statusA)) return false;

                // Quick Filters Integration
                const isDom = r[3] === 0;
                const isCom = r[3] === 1;
                const isUrban = (r[14] || '').toLowerCase() === 'urban';
                const isRural = (r[14] || '').toLowerCase() === 'rural';

                if (!State.quickFilters.domestic && isDom) return false;
                if (!State.quickFilters.commercial && isCom) return false;
                if (!State.quickFilters.urban && isUrban) return false;
                if (!State.quickFilters.rural && isRural) return false;

                if(s && r[7] < s) return false;
                if(e && r[7] > e) return false;
                
                // Cloud Sync Filter
                if(State.driveOnlyFilter && !State.syncedData[r[0]]) return false;

                return true;
            });

            this.updateSidebarStatus();

            // 2. Extract Available Surveyors from Geo Filtered Data
            State.availableSurveyors = [...new Set(geoFiltered.map(r => r[6]))].sort();

            // Auto-reset surveyor filter if not in new data
            if(State.surveyorFilter.length > 0) {
                State.surveyorFilter = State.surveyorFilter.filter(sf => State.availableSurveyors.includes(sf));
            }

            // 3. Apply Surveyor Filter
            if(State.surveyorFilter.length > 0) {
                State.filtered = geoFiltered.filter(r => State.surveyorFilter.includes(r[6]));
            } else {
                State.filtered = geoFiltered;
            }

            this.render();
            
            // Universal Sync: Ensure List View stays in sync with sidebar updates
            if(typeof ListView !== 'undefined') {
                ListView.syncMCUC();
                ListView.syncSurveyorOptions();
                if(document.getElementById('list-view-stage').classList.contains('active')) {
                    ListView.render(); // Force refresh list if currently in it
                }
            }

            if(!isInitial) {
                // Auto-close sidebar on mobile for immediate feedback
                if(window.innerWidth <= 768) {
                    Sidebar.close();
                }
                
                // Ensure map is active if not in List View
                if(!document.getElementById('list-view-stage').classList.contains('active')) {
                    ViewSwitcher.toMap();
                }
            }
            
            this.updateSidebarStatus();
        },

        render() {
            State.markers.clearLayers();
            const bounds = L.latLngBounds();
            const totalCount = State.filtered.length;
            const displayCount = Math.min(totalCount, State.markerLimit);
            document.getElementById('stat-count').innerText = `${displayCount} / ${totalCount}`;
            
            // Dynamic Label Update
            const labelEl = document.getElementById('stat-label');
            if(labelEl) {
                // Determine active context
                let labelHTML = "Total Survey";
                
                // Check filters in order of specificity
                const mcs = App.getSelected('f-mc');
                const tehsils = App.getSelected('f-tehsil');
                const dists = App.getSelected('f-dist');
                
                if(mcs.length > 0) {
                    const ctx = mcs.length === 1 ? mcs[0] : `${mcs.length} Areas`;
                    labelHTML = `Total Survey <span style="font-size:9px; font-weight:400; opacity:0.8; display:block;">(${ctx})</span>`;
                } else if(tehsils.length > 0) {
                    const ctx = tehsils.length === 1 ? tehsils[0] : `${tehsils.length} Tehsils`;
                    labelHTML = `Total Survey <span style="font-size:9px; font-weight:400; opacity:0.8; display:block;">(${ctx})</span>`;
                } else if(dists.length > 0) {
                    const ctx = dists.length === 1 ? dists[0] : `${dists.length} Districts`;
                    labelHTML = `Total Survey <span style="font-size:9px; font-weight:400; opacity:0.8; display:block;">(${ctx})</span>`;
                }
                
                labelEl.innerHTML = labelHTML;
            }

            // Use marker limit from settings
            State.filtered.slice(0, State.markerLimit).forEach(r => {
                // Skip records with invalid coordinates
                if (!r[1] || !r[2] || isNaN(r[1]) || isNaN(r[2])) {
                    console.warn('Skipping record with invalid coordinates:', r[0], 'lat:', r[1], 'lng:', r[2]);
                    return;
                }
                
                const status = r[16].toLowerCase().replace(' ', '-');
                let color = HIERARCHY[r[10]]?.[r[11]]?.[r[12]]?.c || '#2563eb';
                
                // Override color if focusing on payment status visualization
                if(State.payColorMode) {
                    if(status === 'paid') color = '#22c55e';
                    else if(status === 'unpaid') color = '#ef4444';
                    else color = '#94a3b8'; // Not Billed
                }

                const m = L.circleMarker([r[1], r[2]], {
                    radius: 5, fillColor: color, color: 'rgba(0,0,0,0.7)', weight: 0.8, fillOpacity: 0.7,
                    pane: 'markerPane', // Leaflet's marker pane has naturally higher z-index (600)
                    id: r[0].toString() // Store ID for lookup
                });
                
                const imgs = r[9].map(url => `<img src="${url}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;cursor:pointer" onclick="Gallery.open('${url}', '${r[0]}')">`).join('');
                
                const popup = `
                    <div class="pop-card" style="position:relative; padding-top:4px;">
                        <div style="position:absolute; top:36px; right:0; z-index:1;">
                            <span class="pill ${status}" style="font-size:9px; padding:2px 8px; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.2);">${r[16]}</span>
                        </div>
                        
                        <div class="pop-title" style="margin-bottom:12px;">
                            <a href="javascript:void(0)" onclick="ListView.jumpFromMap('${r[0]}')" style="color:var(--primary); text-decoration:none; font-weight:800; border-bottom:1.5px dashed var(--primary); font-size:14px;">ID: #${r[0]}</a>
                        </div>
                        
                        <div style="font-size:12px; margin-bottom:8px">
                            <div style="margin-bottom:8px;">
                                <b style="display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:85%;">${r[6]}</b>
                                <span style="font-size:10px; color:#64748b;">${r[3]===1?'Commercial':'Domestic'}</span>
                            </div>

                            <div style="border-top:1px solid #f1f5f9; margin:8px 0; padding-top:8px; font-size:11px; color:#475569;">
                                <div style="display:flex; justify-content:space-between;"><span>PSID:</span> <b>${r[15]}</b></div>
                                <div style="display:flex; justify-content:space-between;"><span>Amount:</span> <b>Rs. ${r[17]}</b></div>
                                <div style="display:flex; justify-content:space-between;"><span>Date:</span> <b>${r[18]}</b></div>
                            </div>
                            <small style="display:block; margin-top:4px; opacity:0.7;">${r[11]} - ${r[12]}</small>
                        </div>
                        <div style="display:flex; gap:4px; flex-wrap:wrap; margin-top:8px;">${imgs}</div>
                    </div>
                `;
                m.bindPopup(popup);
                State.markers.addLayer(m);
                bounds.extend([r[1], r[2]]);
            });

            if(bounds.isValid()) {
                const currentBounds = State.map.getBounds();
                // Optimization: only fitBounds if markers are outside current view or it's a significant change
                if (!currentBounds.contains(bounds.getSouthWest()) || !currentBounds.contains(bounds.getNorthEast())) {
                    State.map.fitBounds(bounds, {padding:[40,40], maxZoom: 18});
                }
            }
        }
    };

    const ViewSwitcher = {
        toList() {
            try {
                document.getElementById('main-stage').classList.add('hide-map-ui');
                document.getElementById('list-view-stage').classList.add('active');
                const stage = document.getElementById('paid-dashboard-stage');
                if(stage) stage.style.display = 'none';
                
                State.currentIdx = 0;
                ListView.render();
                Sidebar.close();
            } catch(e) { console.error("ViewSwitcher.toList failed:", e); }
        },
        toMap() {
            document.getElementById('main-stage').classList.remove('hide-map-ui');
            document.getElementById('list-view-stage').classList.remove('active');
            document.getElementById('paid-dashboard-stage').style.display = 'none';
            document.getElementById('map').style.visibility = 'visible';
            State.originView = 'map'; // Global reset to map origin
        },
        toDashboard() {
            document.getElementById('main-stage').classList.add('hide-map-ui');
            document.getElementById('paid-dashboard-stage').style.display = 'flex';
            document.getElementById('list-view-stage').classList.remove('active');
            document.getElementById('map').style.visibility = 'hidden';
            Sidebar.close();
        }
    };

    const ListView = {
        init() {
            this.renderFilters();
        },

        renderFilters() {
            const navFilter = document.getElementById('lv-search-container');
            if (!navFilter) return;

            // Store open state/focus if already exists
            const dd = document.getElementById('lv-surveyor-dropdown');
            const isVisible = dd && dd.style.display !== 'none';
            const searchVal = document.getElementById('lv-id-search')?.value || '';

            // 1. Surveyor Options
            let surveyorOptions = "";
            State.availableSurveyors.forEach(name => {
                const isChecked = State.surveyorFilter.includes(name);
                surveyorOptions += `
                    <div class="multi-option ${isChecked ? 'selected' : ''}" data-value="${name}" onclick="ListView.toggleSurveyor(event, '${name}')" style="padding:4px 10px; margin:1px 0; font-size:12px; display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="ListView.handleSurveyorChange(event, '${name}')" style="margin:0; flex-shrink:0;">
                        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${name}</span>
                    </div>
                `;
            });

            // 2. MC/UC Options
            const availableMCs = App.getAvailableMCUCs();
            const selectedMCs = App.getSelectedMCUC();
            let mcOptions = "";
            availableMCs.forEach(item => {
                const isChecked = selectedMCs.includes(item.v);
                mcOptions += `
                    <div class="multi-option ${isChecked ? 'selected' : ''}" data-value="${item.v}" onclick="ListView.toggleMCUC(event, '${item.v}')" style="padding:4px 10px; margin:1px 0; font-size:12px; display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="ListView.handleMCUCChange(event, '${item.v}')" style="margin:0; flex-shrink:0;">
                        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.l}</span>
                    </div>
                `;
            });
            
            navFilter.innerHTML = `
                <div id="lv-surveyor-dropdown" style="display:${isVisible ? 'block' : 'none'}; position:absolute; right:0; top:40px; background:white; border:1px solid #e2e8f0; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.15); max-height:800px; overflow-y:auto; min-width:280px; z-index:1001; padding:20px;">
                    <!-- ID Search -->
                        <div style="margin:0 0 24px 0; display:flex; flex-direction:column; align-items:center;">
                            <div style="font-weight:700; font-size:11px; color:var(--primary); margin-bottom:10px; text-transform:uppercase; letter-spacing:1px; text-align:center;">Quick Search Survey ID</div>
                            <input type="number" id="lv-id-search" placeholder="Type Survey ID Here..." 
                                value="${searchVal}"
                                onkeyup="if(event.key==='Enter') ListView.jumpToID(this.value)"
                                style="width:100%; padding:12px; border:2px solid var(--primary); border-radius:10px; font-size:14px; outline:none; font-family:inherit; text-align:center; background:#fff; color:var(--text); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);">
                        </div>
                        
                        <!-- MC/UC Filter -->
                        <div class="filter-group collapsed" style="margin-bottom:16px; border-top:1px solid #f1f5f9; padding-top:12px;">
                            <div class="filter-header" style="margin-bottom:8px;">
                                <div style="display:flex; align-items:center; gap:6px;">
                                    <button class="toggle-group-btn" onclick="App.toggleFilterGroup(this)">
                                        <i class="material-icons-round" style="font-size:16px;">expand_more</i>
                                    </button>
                                    <span class="filter-label" id="lv-mcuc-count-label">MC/UC (${selectedMCs.length || 'All'})</span>
                                </div>
                                <div class="filter-actions" style="display:flex; gap:6px;">
                                    <button onclick="ListView.selectAllMCUCs(true)" class="select-all-btn" style="padding:4px; font-size:10px;">All</button>
                                    <button onclick="ListView.selectAllMCUCs(false)" class="select-all-btn unselect" style="padding:4px; font-size:10px;">None</button>
                                </div>
                            </div>
                            <div id="lv-mcuc-scroll-area" class="multi-select-container" style="max-height:140px; overflow-y:auto; border:1px solid #f8fafc; border-radius:8px; padding:4px; background:#f8fafc;">
                                ${mcOptions}
                            </div>
                        </div>

                        <!-- Surveyor Filter -->
                        <div class="filter-group collapsed" style="border-top:1px solid #f1f5f9; padding-top:12px;">
                            <div class="filter-header" style="margin-bottom:8px;">
                                <div style="display:flex; align-items:center; gap:6px;">
                                    <button class="toggle-group-btn" onclick="App.toggleFilterGroup(this)">
                                        <i class="material-icons-round" style="font-size:16px;">expand_more</i>
                                    </button>
                                    <span class="filter-label" id="lv-surveyor-count-label">Surveyors (${State.surveyorFilter.length || 'All'})</span>
                                </div>
                                <div class="filter-actions" style="display:flex; gap:6px;">
                                    <button onclick="ListView.selectAllSurveyors(true)" class="select-all-btn" style="padding:4px; font-size:10px;">All</button>
                                    <button onclick="ListView.selectAllSurveyors(false)" class="select-all-btn unselect" style="padding:4px; font-size:10px;">None</button>
                                </div>
                            </div>
                            <div id="lv-surveyor-scroll-area" class="multi-select-container" style="max-height:200px; overflow-y:auto; border:1px solid #f8fafc; border-radius:8px; padding:4px; background:#f8fafc;">
                                ${surveyorOptions}
                            </div>
                        </div>

                        <!-- Sort Options -->
                        <div style="margin-top:20px; border-top:1px solid #f1f5f9; padding-top:16px;">
                            <div style="font-weight:700; font-size:11px; color:#94a3b8; margin-bottom:8px; text-transform:uppercase;">Sort Records By</div>
                            <select id="lv-sort" onchange="ListView.sort(this.value)" style="width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:10px; font-size:13px; outline:none; font-family:inherit; background:#fff; color:var(--text); cursor:pointer;">
                                <option value="id-desc">ID (Newest First)</option>
                                <option value="id-asc">ID (Oldest First)</option>
                                <option value="drive-desc">ID (Latest Drive Upload)</option>
                                <option value="status-paid">Status (Paid First)</option>
                                <option value="status-unpaid">Status (Unpaid First)</option>
                                <option value="status-not-billed">Status (Not Billed First)</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            // Mobile search button adjustment removed (Using relative layout now)
        },

        render() {
            const r = State.filtered[State.currentIdx];
            const el = document.getElementById('lv-content');
            const total = State.filtered.length;
            
            document.getElementById('lv-idx').innerText = total > 0 ? State.currentIdx + 1 : 0;
            document.getElementById('lv-total').innerText = total;

            // Integrity: Clear pending sync files when switching records
            DriveSync.files = []; 

            // Ensure filters are rendered if not already
            if (!document.getElementById('lv-surveyor-dropdown')) {
                this.renderFilters();
            }

            if(!r) { 
                el.innerHTML = `
                    <div class="card-header" style="display:flex; justify-content:center; align-items:center; height:200px;">
                        <div class="card-title" style="color:#64748b">No records match the current filters.</div>
                    </div>`; 
                return; 
            }

            // Contextual Naming
            const dists = App.getSelected('f-dist');
            const tehsils = App.getSelected('f-tehsil');
            let displayName = r[4];
            if(tehsils.length > 1 || dists.length > 1) {
                displayName += ` (${r[11]})`;
            }

            const paidCount = State.filtered.filter(rec => rec[16].toLowerCase() === 'paid').length;
            const payStatus = r[16].toLowerCase().replace(' ', '-');
            let totalPayable = r[20] ? r[20].toString().trim() : '0';
            if (totalPayable.toLowerCase() === 'nan' || !totalPayable) totalPayable = '0';

            el.innerHTML = `
                <div class="card-header" style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div style="flex:1; min-width:0; padding-right:12px;">
                        <div class="card-title" style="margin:0; line-height:1.1; font-size:18px;">Survey ID #${r[0]}</div>
                        <div style="color:#64748b; font-weight:500; font-size:11px; margin-top:2px;">${r[6]} | ${r[7]} ${r[8]}</div>
                    </div>
                    <div style="display:flex; gap:8px; flex-shrink:0; margin-top:2px;">
                         <button onclick="ListView.showOnMap('${r[0]}')" title="Show on Map" style="background:#f1f5f9; color:var(--primary); border:1px solid #e2e8f0; border-radius:6px; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                            <span class="material-icons-round" style="font-size:18px;">my_location</span>
                        </button>
                        <button onclick="ListView.sort('id-desc')" title="Sort ID Descending" style="background:#f1f5f9; color:var(--primary); border:1px solid #e2e8f0; border-radius:6px; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                            <span class="material-icons-round" style="font-size:18px;">arrow_downward</span>
                        </button>
                        <button onclick="ListView.sort('id-asc')" title="Sort ID Ascending" style="background:#f1f5f9; color:var(--primary); border:1px solid #e2e8f0; border-radius:6px; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                            <span class="material-icons-round" style="font-size:18px;">arrow_upward</span>
                        </button>
                        <button onclick="BillVerifier.open('${r[15]}')" title="Verify PSID" style="background:#dcfce7; color:#166534; border:1px solid #bbf7d0; border-radius:6px; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                            <span class="material-icons-round" style="font-size:18px;">verified_user</span>
                        </button>
                        <button onclick="ListView.toggleDropdown(event)" title="Search & Filters" style="background:#f1f5f9; color:var(--primary); border:1px solid #e2e8f0; border-radius:6px; width:32px; height:32px; display:flex; align-items:center; justify-content:center; cursor:pointer;">
                            <span class="material-icons-round" style="font-size:18px;">search</span>
                        </button>
                    </div>
                </div>
                <div class="card-grid">
                    <!-- Row 1: Name, PSID, Status -->
                    <div style="grid-column: span 1;">
                        <div style="color:#2563eb; font-weight:800; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${r[4]}">${r[4]}</div>
                    </div>
                    <div style="grid-column: span 1;">
                        <div style="color:#2563eb; font-weight:800; font-size:14px;">${r[15]}</div>
                    </div>
                    <div style="grid-column: span 1; text-align:right;">
                        <span class="pill ${payStatus}" style="font-size:11px; padding:2px 10px;">${r[16]}</span>
                    </div>

                    <!-- Row 2: UC Type, Consumer Type, Amount -->
                    <div style="grid-column: span 1;">
                        <div style="font-weight:600; font-size:13px; color:var(--text);">${r[14] || 'N/A'}</div>
                    </div>
                    <div style="grid-column: span 1;">
                        <div style="font-weight:600; font-size:13px; color:var(--text);">${r[3]===1?'Commercial':'Domestic'}</div>
                    </div>
                    <div style="grid-column: span 1; text-align:right;">
                        <div style="font-weight:800; font-size:14px; color:#ef4444;">Rs. ${totalPayable}</div>
                    </div>

                    <!-- Row 3: Address (Full Width) -->
                    <div style="grid-column: span 3; border-top:1px solid #f1f5f9; padding-top:8px;">
                        <div style="font-weight:600; font-size:13px; color:var(--text); line-height:1.4;">${r[5]}</div>
                    </div>

                    <!-- Row 4: Area (Full Width) -->
                    <div style="grid-column: span 3; border-top:1px dashed #f1f5f9; padding-top:4px;">
                        <div style="font-weight:600; font-size:12px; color:#64748b;">${r[11]} - ${r[12]}</div>
                    </div>
                </div>
                
                <div class="card-gallery" id="gal-${r[0].toString().replace(/[^a-z0-9]/gi, '_')}">
                    ${r[9].map(url => `<img src="${url}" class="gallery-thumb" onclick="Gallery.open('${url}', '${r[0]}')">`).join('')}
                    <div id="synced-gallery-${r[0].toString().replace(/[^a-z0-9]/gi, '_')}" style="display:contents;"></div>
                </div>

                <!-- Modernized Sync Station (v4.2) -->
                <div class="sync-station">
                    <div class="sync-station-header">
                        <div class="sync-station-title">Google Drive Sync</div>
                        <div class="sync-status-badge" id="drive-status-${r[0].toString().replace(/[^a-z0-9]/gi, '_')}">Checking...</div>
                    </div>

                    <div class="sync-select-wrapper">
                        <select id="drive-email" onchange="DriveSync.saveEmail(this.value)">
                            <option value="">Loading Surveyors...</option>
                        </select>
                    </div>

                    <div id="drive-preview" class="sync-preview-strip"></div>

                    <input type="file" id="drive-upload-input" accept="image/*" capture="environment" multiple style="display:none" onchange="DriveSync.handleFiles(this.files)">
                    
                    <div class="sync-action-grid">
                        <button onclick="document.getElementById('drive-upload-input').click()" class="sync-action-btn camera">
                            <span class="material-icons-round">photo_camera</span> Take Picture
                        </button>
                        <button id="btn-sync-drive" onclick="DriveSync.upload('${r[0]}')" class="sync-action-btn upload">
                            <span class="material-icons-round">cloud_upload</span> Sync Now
                        </button>
                    </div>
                </div>
            `;
            
            // Post-render init for DriveSync (Email & Metadata)
            setTimeout(() => {
                DriveSync.init();
                DriveSync.fetchMetadata(r[0]);
            }, 10);
        },
        next() { if(State.currentIdx < State.filtered.length - 1) { State.currentIdx++; this.render(); }},
        prev() { if(State.currentIdx > 0) { State.currentIdx--; this.render(); }},

        jumpFromMap(id) {
            ViewSwitcher.toList();
            // Allow time for list view stage to activate
            setTimeout(() => {
                const searchInput = document.getElementById('lv-id-search');
                if(searchInput) {
                    searchInput.value = id;
                    this.jumpToID(id);
                }
            }, 100);
        },

        showOnMap(id) {
            const record = RAW_DATA.find(r => r[0].toString() === id.toString());
            if (!record) return;
            
            // State Preservation: Save current filtered state to return later
            // We save a deep copy of the filtered array and the current index
            State.lastView = {
                filtered: [...State.filtered],
                idx: State.currentIdx
            };

            // Override Filters to show only this record
            State.filtered = [record];
            State.currentIdx = 0;
            App.render();
            
            ViewSwitcher.toMap();
            State.map.flyTo([record[1], record[2]], 19);
            
            setTimeout(() => {
                State.markers.eachLayer(layer => {
                    if (layer.options.id === id.toString()) {
                        layer.openPopup(); 
                    }
                });
            }, 1000); // Increased timeout for flyTo completion

            // Update Label with Restore option
            const statLabel = document.getElementById('stat-label');
            if(statLabel) {
                statLabel.innerHTML = `Single ID Mode <a href="javascript:void(0)" onclick="ListView.restoreView()" style="color:var(--primary); margin-left:8px; text-decoration:underline;">[Return to List]</a>`;
            }
        },

        restoreView() {
            if (State.lastView) {
                State.filtered = [...State.lastView.filtered];
                State.currentIdx = State.lastView.idx;
                State.lastView = null;
                
                // Re-calculate payColorMode based on current filters
                const payFilters = App.getSelected('f-pay');
                State.payColorMode = payFilters.length > 0;
                
                ViewSwitcher.toMap(); // Ensure we are NOT in list view when rendering markers
                App.render();
                
                // Now switch to list view
                document.getElementById('main-stage').classList.add('hide-map-ui');
                document.getElementById('list-view-stage').classList.add('active');
                ListView.render();

                // Restore sidebar state if it was hidden
                Sidebar.close();
            } else {
                App.apply();
            }
        },

        sort(criteria) {
            if (criteria === 'id-desc') {
                State.filtered.sort((a, b) => b[0] - a[0]);
            } else if (criteria === 'id-asc') {
                State.filtered.sort((a, b) => a[0] - b[0]);
            } else if (criteria === 'status-paid') {
                State.filtered.sort((a, b) => {
                    if (a[16].toLowerCase() === 'paid' && b[16].toLowerCase() !== 'paid') return -1;
                    if (a[16].toLowerCase() !== 'paid' && b[16].toLowerCase() === 'paid') return 1;
                    return 0;
                });
            } else if (criteria === 'status-unpaid') {
                State.filtered.sort((a, b) => {
                    if (a[16].toLowerCase() === 'unpaid' && b[16].toLowerCase() !== 'unpaid') return -1;
                    if (a[16].toLowerCase() !== 'unpaid' && b[16].toLowerCase() === 'unpaid') return 1;
                    return 0;
                });
            } else if (criteria === 'status-not-billed') {
                State.filtered.sort((a, b) => {
                    const statusA = a[16].toLowerCase();
                    const statusB = b[16].toLowerCase();
                    if (statusA === 'not billed' && statusB !== 'not billed') return -1;
                    if (statusA !== 'not billed' && statusB === 'not billed') return 1;
                    return 0;
                });
            } else if (criteria === 'drive-desc') {
                State.filtered.sort((a, b) => {
                    const timeA = State.syncedData[a[0]] ? new Date(State.syncedData[a[0]]).getTime() : 0;
                    const timeB = State.syncedData[b[0]] ? new Date(State.syncedData[b[0]]).getTime() : 0;
                    return timeB - timeA;
                });
            }
            State.currentIdx = 0;
            this.render();
        },

        toggleDropdown(e) {
            if (e) e.stopPropagation();
            const dd = document.getElementById('lv-surveyor-dropdown');
            const isVisible = dd.style.display !== 'none';
            
            if (isVisible) {
                dd.style.display = 'none';
                document.removeEventListener('click', this._outsideClickHandler);
            } else {
                dd.style.display = 'block';
                // Auto-focus the search field for better UX
                setTimeout(() => {
                    const searchInput = document.getElementById('lv-id-search');
                    if(searchInput) {
                        searchInput.focus();
                        searchInput.select(); // Select existing text if any
                    }
                }, 50);

                this._outsideClickHandler = (e) => {
                    if (!dd.contains(e.target) && !e.target.closest('button[onclick*="toggleDropdown"]')) {
                        dd.style.display = 'none';
                        document.removeEventListener('click', this._outsideClickHandler);
                    }
                };
                document.addEventListener('click', this._outsideClickHandler);
            }
        },

        jumpToID(id) {
            if(!id) return;
            const searchId = id.toString().trim();
            let idx = State.filtered.findIndex(r => r[0].toString().trim() === searchId);
            
            if (idx === -1) {
                // HIGH PERFORMANCE: Find record in global RAW_DATA directly
                const record = RAW_DATA.find(r => r[0].toString().trim() === searchId);
                if (record) {
                    console.log(`Survey ID #${id} found globally. Entering Single ID Mode...`);
                    
                    // State Preservation for Return logic
                    if(!State.lastView) {
                        State.lastView = {
                            filtered: [...State.filtered],
                            idx: State.currentIdx
                        };
                    }
                    
                    State.filtered = [record];
                    State.currentIdx = 0;
                    this.render();
                    
                    // Open Popup on Map if needed
                    setTimeout(() => {
                        State.markers.eachLayer(layer => {
                            if(layer.options.id === searchId) {
                                layer.openPopup();
                            }
                        });
                    }, 500);
                    
                    // Update Label with Restore option
                    const statLabel = document.getElementById('stat-label');
                    if(statLabel) {
                        statLabel.innerHTML = `Single ID Mode <a href="javascript:void(0)" onclick="ListView.restoreView()" style="color:var(--primary); margin-left:8px; text-decoration:underline; font-size:10px;">[RETURN]</a>`;
                    }
                    return;
                }
            }

            if (idx !== -1) {
                State.currentIdx = idx;
                this.render();
                // Close dropdown if open
                const dd = document.getElementById('lv-surveyor-dropdown');
                if(dd) dd.style.display = 'none';
            } else {
                alert(`Survey ID #${id} could not be found in the database.`);
            }
        },

        jumpFromMap(id) {
            document.getElementById('list-view-stage').classList.add('active');
            this.jumpToID(id);
        },
        
        toggleSurveyor(e, name) {
            if(e.target.tagName === 'INPUT') return;
            const row = e.currentTarget;
            const cb = row.querySelector('input');
            cb.checked = !cb.checked;
            row.classList.toggle('selected', cb.checked);
            this.updateSurveyorFilter();
        },
        
        handleSurveyorChange(e, name) {
            const row = e.target.closest('.multi-option');
            row.classList.toggle('selected', e.target.checked);
            this.updateSurveyorFilter();
        },
        
        selectAllSurveyors(selectAll) {
            const dd = document.getElementById('lv-surveyor-dropdown');
            const checkboxes = dd.querySelectorAll('#lv-surveyor-dropdown div[onclick*="toggleSurveyor"] input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = selectAll;
                cb.closest('.multi-option').classList.toggle('selected', selectAll);
            });
            this.updateSurveyorFilter();
        },

        toggleMCUC(e, val) {
            if(e.target.tagName === 'INPUT') return;
            const row = e.currentTarget;
            const cb = row.querySelector('input');
            cb.checked = !cb.checked;
            row.classList.toggle('selected', cb.checked);
            this.updateMCUCFilter();
        },

        handleMCUCChange(e, val) {
            const row = e.target.closest('.multi-option');
            row.classList.toggle('selected', e.target.checked);
            this.updateMCUCFilter();
        },

        selectAllMCUCs(selectAll) {
            const dd = document.getElementById('lv-surveyor-dropdown');
            const checkboxes = dd.querySelectorAll('#lv-surveyor-dropdown div[onclick*="toggleMCUC"] input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = selectAll;
                cb.closest('.multi-option').classList.toggle('selected', selectAll);
            });
            this.updateMCUCFilter();
        },
        
        updateSurveyorFilter() {
            const dd = document.getElementById('lv-surveyor-dropdown');
            if (!dd) return;
            const checkboxes = dd.querySelectorAll('#lv-surveyor-dropdown div[onclick*="toggleSurveyor"] input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.closest('.multi-option').getAttribute('data-value'));
            
            State.surveyorFilter = selected.length > 0 ? selected : [];
            App.apply();
            
            State.currentIdx = 0;
            this.render();

            const countLabel = document.getElementById('lv-surveyor-count-label');
            if (countLabel) {
                countLabel.innerText = `Filter Surveyors (${selected.length || 'All'})`;
            }
        },

        updateMCUCFilter() {
            const dd = document.getElementById('lv-surveyor-dropdown');
            if (!dd) return;
            const checkboxes = dd.querySelectorAll('#lv-surveyor-dropdown div[onclick*="toggleMCUC"] input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.closest('.multi-option').getAttribute('data-value'));
            
            // Sync to sidebar
            App.setSelected('f-mc', selected);
            App.apply();
            
            State.currentIdx = 0;
            this.render();

            // Manually update the count label
            const countLabel = document.getElementById('lv-mcuc-count-label');
            if (countLabel) {
                countLabel.innerText = `Filter MC/UC (${selected.length || 'All'})`;
            }

            // Since MC/UC change might change available surveyors, update surveyor options in DD without closing
            // But to be 100% persistent, we just update the DOM elements for surveyors if they changed
            // For now, let's keep it simple: if surveyors changed, we might need a partial re-render of that section
            // However, typical flow is MC/UC selection first.
            this.syncSurveyorOptions();
        },

        syncSurveyorOptions() {
            const surveyorScrollArea = document.getElementById('lv-surveyor-scroll-area');
            if (!surveyorScrollArea) return;

            let surveyorOptions = "";
            State.availableSurveyors.forEach(name => {
                const isChecked = State.surveyorFilter.includes(name);
                surveyorOptions += `
                    <div class="multi-option ${isChecked ? 'selected' : ''}" data-value="${name}" onclick="ListView.toggleSurveyor(event, '${name}')" style="padding:4px 10px; margin:1px 0; font-size:12px; display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="ListView.handleSurveyorChange(event, '${name}')" style="margin:0; flex-shrink:0;">
                        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${name}</span>
                    </div>
                `;
            });
            surveyorScrollArea.style.display = 'block';
            surveyorScrollArea.innerHTML = surveyorOptions;

            const countLabel = document.getElementById('lv-surveyor-count-label');
            if (countLabel) {
                countLabel.innerText = `Filter Surveyors (${State.surveyorFilter.length || 'All'})`;
            }
        },

        syncMCUC() {
            const mcucScrollArea = document.getElementById('lv-mcuc-scroll-area');
            if (!mcucScrollArea) return;

            const availableMCs = App.getAvailableMCUCs();
            const selectedMCs = App.getSelectedMCUC();
            let mcOptions = "";
            availableMCs.forEach(item => {
                const isChecked = selectedMCs.includes(item.v);
                mcOptions += `
                    <div class="multi-option ${isChecked ? 'selected' : ''}" data-value="${item.v}" onclick="ListView.toggleMCUC(event, '${item.v}')" style="padding:4px 10px; margin:1px 0; font-size:12px; display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="ListView.handleMCUCChange(event, '${item.v}')" style="margin:0; flex-shrink:0;">
                        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.l}</span>
                    </div>
                `;
            });
            mcucScrollArea.innerHTML = mcOptions;

            const countLabel = document.getElementById('lv-mcuc-count-label');
            if (countLabel) {
                countLabel.innerText = `Filter MC/UC (${selectedMCs.length || 'All'})`;
            }
        }
    };

    const Stats = {
        open() {
            const dataByName = {};
            State.filtered.forEach(r => {
                const name = r[6];
                if(!dataByName[name]) dataByName[name] = [];
                dataByName[name].push(r);
            });

            // Sort staff by count
            const sorted = Object.entries(dataByName).sort((a,b) => b[1].length - a[1].length);
            
            // Dynamic Heading
            const dists = App.getSelected('f-dist').join(', ') || 'All';
            const tehsils = App.getSelected('f-tehsil').join(', ') || 'All';
            document.getElementById('stats-title').innerHTML = `Staff Workflow Leaderboard: ${dists} (${tehsils}) <span style="margin-left:30px; font-size:0.9em; color:#475569;">Total: ${State.filtered.length}</span>`;

            let html = `<table style="width:100%; border-collapse:collapse; font-size:12px; min-width:650px;">
                <thead style="background:#f8fafc; position:sticky; top:0; z-index:10;">
                    <tr>
                        <th style="padding:8px; text-align:center; width: 80px;">Count</th>
                        <th style="padding:8px; text-align:left;">Staff</th>
                        <th style="padding:8px; text-align:center;">Idle</th>
                        <th style="padding:8px; text-align:center;">First / Last</th>
                        <th style="padding:8px; text-align:center;">Status</th>
                    </tr>
                </thead>
                <tbody>`;

            sorted.forEach(([name, records], i) => {
                // Calculate Stats Dynamically for the filtered range
                const sortedRecs = records.slice().sort((a,b) => a[8].localeCompare(b[8]));
                const first = sortedRecs[0][8];
                const last = sortedRecs[sortedRecs.length - 1][8];
                
                let warn = 0, idle = 0;
                const windowStart = "10:00:00";
                const windowEnd = "17:00:00";
                const shutdownCutoff = "16:55:00";

                for(let j=1; j<sortedRecs.length; j++) {
                    const t1 = sortedRecs[j-1][8];
                    const t2 = sortedRecs[j][8];
                    if(t1 < windowStart || t1 > windowEnd) continue;
                    
                    const d1 = new Date(`2000-01-01T${t1}`);
                    const d2 = new Date(`2000-01-01T${t2}`);
                    let diff = (d2 - d1) / 60000;
                    
                    const lStart = new Date(`2000-01-01T13:00:00`);
                    const lEnd = new Date(`2000-01-01T14:00:00`);
                    const overlapStart = new Date(Math.max(d1, lStart));
                    const overlapEnd = new Date(Math.min(d2, lEnd));
                    if(overlapEnd > overlapStart) diff -= (overlapEnd - overlapStart) / 60000;

                    if(diff > 60) idle++;
                    else if(diff > 30) warn++;
                }

                // Tiered Trophies
                let trophy = "";
                if(i === 0) trophy = `<span class="trophy gold">ðŸ†</span>`;
                else if(i === 1) trophy = `<span class="trophy silver">ðŸ¥ˆ</span>`;
                else if(i < 5) trophy = `<span class="trophy bronze">ðŸ¥‰</span>`;

                let statusMsg = '<span class="status-msg status-ok">Active</span>';
                if(idle > 0) statusMsg = '<span class="status-msg status-idle">Idle!</span>';
                else if(warn > 0) statusMsg = '<span class="status-msg status-warn">Delay</span>';
                
                const countClass = records.length > 100 ? 'count-high' : '';
                const idleClass = idle > 0 ? 'idle-danger' : (warn > 0 ? 'idle-warn' : '');
                const lastClass = last < shutdownCutoff ? 'time-warning' : '';
                
                html += `<tr class="rank-row" style="${i === 0 ? 'height: 60px;' : ''}">
                    <td style="padding:8px; text-align:center;">
                        <span class="count-badge ${countClass}">${records.length}</span>
                    </td>
                    <td style="padding:8px; font-weight:700;">${name}${trophy}</td>
                    <td style="padding:8px; text-align:center;" class="${idleClass}">${idle + warn}</td>
                    <td style="padding:8px; text-align:center; font-size:12px; color:#475569;">
                        <b>${first}</b><br><span class="${lastClass}">${last}</span>
                    </td>
                    <td style="padding:8px; text-align:center;">${statusMsg}</td>
                </tr>`;
            });
            
            html += `</tbody></table>`;
            document.getElementById('stats-body').innerHTML = html;
            document.getElementById('modal-stats').style.display = 'flex';
        },
        close() { document.getElementById('modal-stats').style.display = 'none'; }
    };

    const Gallery = {
        scale: 1, rot: 0,
        images: [], idx: 0,
        posX: 0, posY: 0,
        isDragging: false,
        startX: 0, startY: 0,
        
        open(src, surveyId) {
            const safeId = surveyId.toString().replace(/[^a-z0-9]/gi, '_');
            const galContainer = document.getElementById(`gal-${safeId}`);
            if (galContainer) {
                // Collect ALL images from the gallery container (original and synced)
                const allThumbs = Array.from(galContainer.querySelectorAll('img'));
                this.images = allThumbs.map(img => img.src);
            } else {
                const record = RAW_DATA.find(r => r[0] == surveyId);
                this.images = record ? record[9] : [src];
            }
            
            this.idx = this.images.indexOf(src);
            if(this.idx === -1) this.idx = 0;
            
            this.updateImage();
            document.getElementById('gallery').classList.add('active');
            
            // Add Keyboard listeners
            this._boundKeyHandler = (e) => this.handleKeys(e);
            window.addEventListener('keydown', this._boundKeyHandler);
        },
        
        close() { 
            document.getElementById('gallery').classList.remove('active');
            window.removeEventListener('keydown', this._boundKeyHandler);
        },
        
        handleKeys(e) {
            if(e.key === 'ArrowRight') this.next();
            if(e.key === 'ArrowLeft') this.prev();
            if(e.key === 'Escape') this.close();
            if(e.key === '+' || e.key === '=') this.zoomIn();
            if(e.key === '-' || e.key === '_') this.zoomOut();
            if(e.key.toLowerCase() === 'r') this.rotate();
        },
        
        next() { this.idx = (this.idx + 1) % this.images.length; this.updateImage(); },
        prev() { this.idx = (this.idx - 1 + this.images.length) % this.images.length; this.updateImage(); },
        
        updateImage() {
            const img = document.getElementById('gal-img');
            img.src = this.images[this.idx];
            this.reset();
            const counter = document.getElementById('gal-counter');
            if(counter) counter.innerText = `${this.idx + 1} / ${this.images.length}`;
        },
        
        rotate() { this.rot = (this.rot + 90) % 360; this.updateTransform(); },
        zoomIn() { this.scale = Math.min(5, this.scale + 0.3); this.updateTransform(); },
        zoomOut() { this.scale = Math.max(0.5, this.scale - 0.3); this.updateTransform(); },
        reset() {
            this.scale = 1; this.rot = 0;
            this.posX = 0; this.posY = 0;
            this.updateTransform();
        },
        
        updateTransform() {
            const img = document.getElementById('gal-img');
            if (this.isDragging) img.classList.add('no-transition');
            else img.classList.remove('no-transition');
            
            img.style.transform = `translate(${this.posX}px, ${this.posY}px) rotate(${this.rot}deg) scale(${this.scale})`;
            
            // Standard cursor behavior
            if (this.scale > 1.05) {
                img.style.cursor = this.isDragging ? 'grabbing' : 'grab';
            } else {
                img.style.cursor = 'default';
            }
        },

        // Interaction state
        onStart(e) {
            if (e.target.closest('.gal-controls')) return;
            
            if (e.type === 'touchstart') {
                this.touchstartX = e.touches[0].clientX;
                this.touchstartY = e.touches[0].clientY;
                
                // For 2-finger panning / pinching
                if (e.touches.length === 2) {
                    this._pinchStartDist = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    this._pinchStartScale = this.scale;
                    this._pinchStartX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - this.posX;
                    this._pinchStartY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - this.posY;
                    this.isDragging = false;
                } else {
                    // Start dragging for mobile (if zoomed)
                    if (this.scale > 1.01) {
                        this.isDragging = true;
                        this.startX = e.touches[0].clientX - this.posX;
                        this.startY = e.touches[0].clientY - this.posY;
                    }
                }
            } else {
                // Desktop Mouse Start
                if (this.scale > 1.01) {
                    this.isDragging = true;
                    this.startX = e.clientX - this.posX;
                    this.startY = e.clientY - this.posY;
                    this.updateTransform();
                }
            }
        },
        
        onMove(e) {
            // Early return if no valid active state
            if (!this.isDragging && !this._pinchStartDist) return;
            e.preventDefault();

            if (e.type === 'touchmove') {
                // Mobile Pinch and 2-Finger Pan
                if (e.touches.length === 2 && this._pinchStartDist) {
                    const dist = Math.hypot(
                        e.touches[1].clientX - e.touches[0].clientX,
                        e.touches[1].clientY - e.touches[0].clientY
                    );
                    const zoomFactor = dist / this._pinchStartDist;
                    this.scale = Math.min(5, Math.max(0.5, this._pinchStartScale * zoomFactor));

                    if (this.scale > 1.01) {
                        const midX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                        const midY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                        this.posX = midX - this._pinchStartX;
                        this.posY = midY - this._pinchStartY;
                    }
                    this.updateTransform();
                } 
                // Mobile Single Touch Pan
                else if (this.isDragging && this.scale > 1.01) {
                    this.posX = e.touches[0].clientX - this.startX;
                    this.posY = e.touches[0].clientY - this.startY;
                    this.updateTransform();
                }
            } else {
                // Desktop Mouse Move (Strict button check + drag state)
                if (this.isDragging && this.scale > 1.01 && (e.buttons & 1)) {
                    this.posX = e.clientX - this.startX;
                    this.posY = e.clientY - this.startY;
                    this.updateTransform();
                } else if (this.isDragging) {
                    // Safety: if mouse is up but listener missed it
                    this.onEnd(e);
                }
            }
        },
        
        onEnd(e) { 
            // Mobile Swipe Detection
            if (e.type === 'touchend' && this.scale <= 1.01 && this.touchstartX !== undefined) {
                const deltaX = e.changedTouches[0].clientX - this.touchstartX;
                const deltaY = e.changedTouches[0].clientY - this.touchstartY;
                
                if (Math.abs(deltaX) > 60 && Math.abs(deltaY) < 100) {
                    if (deltaX < 0) this.next();
                    else this.prev();
                }
            }

            this.isDragging = false; 
            this._pinchStartDist = null;
            this.touchstartX = undefined;
            this.updateTransform(); // Refresh cursor state
        },
        
        onWheel(e) {
            e.preventDefault();
            const zoomSpeed = 0.2;
            const prevScale = this.scale;
            
            // Calculate new scale
            if (e.deltaY < 0) this.scale = Math.min(5, this.scale + zoomSpeed);
            else this.scale = Math.max(0.5, this.scale - zoomSpeed);
            
            // Zoom towards cursor (Standard Pro behavior)
            if (this.scale !== prevScale) {
                const rect = document.getElementById('gal-vp').getBoundingClientRect();
                const mouseX = e.clientX - (rect.left + rect.width / 2);
                const mouseY = e.clientY - (rect.top + rect.height / 2);
                
                const ratio = (this.scale / prevScale) - 1;
                this.posX -= (mouseX - this.posX) * ratio;
                this.posY -= (mouseY - this.posY) * ratio;
            }
            
            this.updateTransform();
        },
        
        clickNav(e) {
            // Only navigate if NOT dragging significantly and NOT clicking image when zoomed
            if (this.scale > 1.2 && e.target.tagName === 'IMG') return; 
            if (e.target.closest('.gal-controls')) return;
            
            const width = document.getElementById('gal-vp').clientWidth;
            const rect = document.getElementById('gal-vp').getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            
            // Threshold for navigation
            if(clickX > width * 0.7) this.next();
            else if (clickX < width * 0.3) this.prev();
        }
    };

    const DriveSync = {
        files: [],
        MAX: 3,
        APP_URL: 'https://script.google.com/macros/s/AKfycbxKdvyJf00rvveSyqPVMvk1iNSq_gbmFAHKkk51utr0Ptaoetqwyu_ftwritA-W06VmLw/exec', 
        whitelist: null,
        currentDriveCount: 0,
        
        _safeId(id) { return id.toString().replace(/[^a-z0-9]/gi, '_'); },

        saveEmail(email) {
            localStorage.setItem('surveyor_email', email);
        },

        getEmail() {
            return localStorage.getItem('surveyor_email') || '';
        },

        init() {
            if (this.whitelist) {
                this.renderWhitelist(this.whitelist);
            } else {
                this.fetchWhitelist();
            }
        },

        async fetchWhitelist() {
            if (!this.APP_URL) return;
            this.APP_URL = this.APP_URL.trim();
            console.log("Checking connection to:", this.APP_URL);
            
            try {
                const resp = await fetch(`${this.APP_URL}?action=get_whitelist`, {
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                
                const res = await resp.json();
                if (res.status === 'success' && res.data) {
                    this.whitelist = res.data;
                    this.renderWhitelist(res.data);
                } else {
                    throw new Error(res.message || "Invalid Response");
                }
            } catch (e) { 
                console.error("Whitelist fetch error:", e);
                const select = document.getElementById('drive-email');
                if(select) {
                    select.innerHTML = `<option value="">âš ï¸ Connection Failed: ${e.message}</option>`;
                    select.style.borderColor = 'var(--danger)';
                }
            }
        },

        renderWhitelist(emails) {
            const select = document.getElementById('drive-email');
            if (!select) return;
            
            const savedEmail = this.getEmail();
            let html = '<option value="">Select Surveyor Email</option>';
            emails.forEach(email => {
                const selected = email.toLowerCase() === savedEmail.toLowerCase() ? 'selected' : '';
                html += `<option value="${email}" ${selected}>${email}</option>`;
            });
            select.innerHTML = html;
        },

        async fetchAllSyncedData() {
            if (!this.APP_URL) return;
            console.log("Fetching all synced IDs...");
            try {
                const resp = await fetch(`${this.APP_URL}?action=get_all_synced_ids`);
                const res = await resp.json();
                if (res.status === 'success' && res.data) {
                    // Expecting res.data to be { surveyId: timestamp, ... }
                    State.syncedData = res.data;
                    console.log("Synced data loaded:", Object.keys(State.syncedData).length, "records");
                    // Re-apply filters if the filter was already enabled or just to update status
                    if(State.driveOnlyFilter) App.apply();
                }
            } catch (e) {
                console.error("Error fetching all synced data:", e);
            }
        },

        async fetchMetadata(surveyId) {
            if (!this.APP_URL) return;
            const sid = this._safeId(surveyId);
            const statusEl = document.getElementById(`drive-status-${sid}`);
            try {
                const resp = await fetch(`${this.APP_URL}?surveyId=${encodeURIComponent(surveyId)}`);
                const res = await resp.json();
                if (res.status === 'success') {
                    this.currentDriveCount = res.totalCount || 0;
                    this.renderSyncedImages(surveyId, res.data || []);
                    this.updateStatus(surveyId);
                } else {
                    this.updateStatus(surveyId); 
                }
            } catch (e) { 
                console.error("Metadata fetch error:", e); 
                this.updateStatus(surveyId); 
            }
        },

        renderSyncedImages(surveyId, images) {
            const sid = this._safeId(surveyId);
            const gal = document.getElementById(`synced-gallery-${sid}`);
            if (!gal) return;
            
            gal.innerHTML = images.map(img => {
                // Use the thumbnail endpoint for better direct embedding support
                const url = `https://drive.google.com/thumbnail?id=${img.id}&sz=w1000`;
                const date = new Date(img.timestamp).toLocaleString();
                const meta = `Uploaded by: ${img.uploader}\nTime: ${date}`;
                console.log("Rendering synced image:", img.name, url);
                return `
                    <div class="gallery-thumb synced" onclick="Gallery.open('${url}', '${surveyId}')" title="${meta}" style="position:relative; border:2px solid #10b981; overflow:hidden; background:#f8fafc;">
                        <img src="${url}" style="width:100%; height:100%; object-fit:cover;" onerror="this.onerror=null; this.src='https://placehold.co/100x100?text=Private+Image'; console.warn('Image private or missing');">
                        <div style="position:absolute; bottom:0; left:0; right:0; background:rgba(16,185,129,0.9); color:white; font-size:9px; padding:2px 4px; font-weight:800; text-align:center; transform:translateY(0); transition:transform 0.2s;">
                            SYNCED
                        </div>
                    </div>
                `;
            }).join('');
        },

        updateStatus(surveyId) {
            const sid = this._safeId(surveyId);
            const statusBadge = document.getElementById(`drive-status-${sid}`);
            const syncBtn = document.getElementById('btn-sync-drive');
            const camBtn = document.querySelector('.sync-action-btn.camera');
            
            if (!statusBadge) return;
            
            const remaining = this.MAX - this.currentDriveCount - this.files.length;
            statusBadge.innerText = remaining > 0 ? `${remaining} Slots Available` : "Limit Reached";
            statusBadge.style.color = remaining <= 0 ? "#ef4444" : "var(--primary)";
            statusBadge.style.background = remaining <= 0 ? "#fef2f2" : "#eff6ff";
            statusBadge.style.borderColor = remaining <= 0 ? "#fee2e2" : "#dbeafe";
            
            if (syncBtn) syncBtn.disabled = (this.files.length === 0);
            if (camBtn) camBtn.disabled = (remaining <= 0);
        },

        // Legacy compatibility: ensure background calls don't crash
        updateHub() { this.updateStatus(State.filtered[State.currentIdx][0]); },

        handleFiles(fileList) {
            const newFiles = Array.from(fileList);
            const remaining = this.MAX - this.currentDriveCount;
            this.files = [...this.files, ...newFiles].slice(0, remaining);
            this.renderPreview();
            this.updateStatus(State.filtered[State.currentIdx][0]);
        },
        
        renderPreview() {
            const container = document.getElementById('drive-preview');
            const syncBtn = document.getElementById('btn-sync-drive');
            if(!container) return;

            if (this.files.length === 0) {
                container.style.display = 'none';
                if(syncBtn) syncBtn.disabled = true;
                return;
            }
            
            container.style.display = 'flex';
            if(syncBtn) syncBtn.disabled = false;
            
            container.innerHTML = this.files.map((f, i) => `
                <div class="preview-item">
                    <img src="${URL.createObjectURL(f)}">
                    <button class="remove-btn" onclick="DriveSync.remove(${i})">
                        <span class="material-icons-round" style="font-size:12px;">close</span>
                    </button>
                </div>
            `).join('');
        },
        
        remove(idx) {
            this.files.splice(idx, 1);
            this.renderPreview();
            this.updateStatus(State.filtered[State.currentIdx][0]);
        },

        compressImage(file, maxWidth = 1024, quality = 0.6) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob((blob) => {
                            resolve(new File([blob], file.name.replace(/\.[^/.]+$/, "") + ".webp", { type: 'image/webp' }));
                        }, 'image/webp', quality);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        },
        
        async upload(surveyId) {
            const email = this.getEmail();
            const btn = document.getElementById('btn-sync-drive');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="material-icons-round rotate">sync</span> Processing...';
            
            try {
                // Parallelized Compression & Upload
                const uploadPromises = this.files.map(async (file, i) => {
                    const compressed = await this.compressImage(file);
                    const base64 = await this.toBase64(compressed);
                    const name = `${surveyId}_img${this.currentDriveCount + i + 1}.webp`; 
                    
                    const response = await fetch(this.APP_URL, {
                        method: 'POST',
                        mode: 'cors', 
                        headers: { 'Content-Type': 'text/plain' }, 
                        body: JSON.stringify({ name, data: base64, surveyId, email, timestamp: new Date().toISOString() })
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const result = await response.json();
                    if (result.status === "error") throw new Error(result.message);
                    return result;
                });

                await Promise.all(uploadPromises);
                
                alert(`Successfully synced ${this.files.length} images to Google Drive!`);
                this.files = [];
                this.renderPreview();
                this.fetchMetadata(surveyId); 
            } catch (e) {
                console.error("Upload error:", e);
                let msg = e.message;
                if (msg === "Failed to fetch") msg = "Check Connection or Blockers";
                alert("Sync failed: " + msg);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        },
        
        toBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
    };


    const LayerManager = {
        activeLayers: [],
        pendingSelections: new Set(),
        activeTab: null,
        
        _getFeatureColor(feature, palette) {
             // Robust hashing using ID or Name
             const idStr = (feature.properties.fid || feature.properties.name || 'Unnamed').toString();
             let hash = 0;
             for (let i = 0; i < idStr.length; i++) {
                 hash = idStr.charCodeAt(i) + ((hash << 5) - hash);
             }
             return palette[Math.abs(hash) % palette.length];
        },

        load(keysToLoad) {
             this.clear();
             const palette = [
                 '#3b82f6', '#10b981', '#f59e0b', '#ef4444', 
                 '#8b5cf6', '#ec4899', '#06b6d4', '#f97316',
                 '#14b8a6', '#6366f1'
             ];

             keysToLoad.forEach((key, index) => {
                 const [city, layerName] = key.split('|');
                 if(GEO_LAYERS[city] && GEO_LAYERS[city][layerName]) {
                    const layerColor = palette[index % palette.length];
                    const lowerLayer = layerName.toLowerCase();
                    const isWardLayer = lowerLayer.includes('urban_ward') || lowerLayer.includes('urban_uc');
                    const isCantonment = lowerLayer.includes('cantonment');

                    const layer = L.geoJSON(GEO_LAYERS[city][layerName], {
                        layerKey: key, 
                        interactive: true,
                        pane: 'kmlPane',
                        style: (feature) => {
                            let color = layerColor;
                            if (isCantonment) {
                                color = '#ef4444'; // Permanent Red for Cantonment
                            } else if (isWardLayer && feature.properties) {
                                color = this._getFeatureColor(feature, palette);
                            }
                            return {
                                color: color, weight: 0, opacity: 0.8, dashArray: '5, 5', 
                                fillColor: color, fillOpacity: 0.15
                            };
                        },
                        onEachFeature: (feature, layer) => {
                             // Tooltips removed as requested
                        }
                    }).addTo(State.map);
                    this.activeLayers.push(layer);
                 }
             });
        },
        
        clear() {
            this.activeLayers.forEach(l => State.map.removeLayer(l));
            this.activeLayers = [];
        },
        
        initPendingState() {
            this.pendingSelections = new Set();
            this.activeLayers.forEach(l => {
                if(l.options.layerKey) this.pendingSelections.add(l.options.layerKey);
            });
        },
        
        showToast(msg) {
             const toast = document.createElement('div');
             toast.className = 'toast-msg';
             toast.innerText = msg;
             document.body.appendChild(toast);
             setTimeout(() => { toast.classList.add('show'); }, 10);
             setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        },
        
        renderSettingsUI() {
            const container = document.getElementById('settings-layers-container');
            if (!container) return;
            
            const kmlCities = Object.keys(GEO_LAYERS).sort();
            const mainTabs = ['ðŸ“Š Stats', 'ðŸ“ Marker Limit'];
            
            if (!this.activeTab) this.activeTab = 'ðŸ“Š Stats';
            
            // Tab Grouping & Rendering (Unified Scrollable Row)
            let tabsHtml = `<div class="settings-tabs-row">`;
            
            // Core Tabs
            mainTabs.forEach(tab => {
                const isActive = this.activeTab === tab;
                tabsHtml += `
                    <button onclick="LayerManager.switchTab('${tab}')" class="settings-tab-btn ${isActive?'active':''}">
                        ${tab}
                    </button>`;
            });
            
            // City Tabs
            kmlCities.forEach(city => {
                const isActive = this.activeTab === city;
                tabsHtml += `
                    <button onclick="LayerManager.switchTab('${city}')" class="settings-tab-btn ${isActive?'active':''}">
                        ${city}
                    </button>`;
            });
            tabsHtml += `</div>`;
            
            let contentHtml = '<div style="flex:1; overflow-y:auto; padding:24px; padding-bottom:100px;">';
            
            if (this.activeTab === 'ðŸ“Š Stats') {
                contentHtml += `
                    <div style="background:#eff6ff; border-radius:16px; padding:20px; border:1px solid #dbeafe; box-shadow: 0 4px 12px rgba(37,99,235,0.05);">
                         <h4 style="margin:0 0 16px 0; color:#1e40af; font-size:12px; font-weight:800; text-transform:uppercase; letter-spacing:1px;">Data Coverage Overview</h4>
                         <div style="grid-template-columns:1fr 1fr; display:grid; gap:12px;">
                             <div style="background:white; padding:16px; border-radius:12px; text-align:center; grid-column:span 2; border:1px solid #dbeafe;">
                                 <div style="font-size:10px; color:#64748b; font-weight:800; letter-spacing:1px;">TOTAL SURVEYS</div>
                                 <div id="set-total-surveys" style="font-size:28px; font-weight:900; color:#1e293b; margin-top:4px;">0</div>
                             </div>
                             <div style="background:white; padding:12px; border-radius:12px; text-align:center; border:1px solid #dcfce7;">
                                 <div style="font-size:9px; color:#16a34a; font-weight:800; letter-spacing:0.5px;">DOMESTIC</div>
                                 <div id="set-total-domestic" style="font-size:20px; font-weight:900; color:#16a34a;">0</div>
                             </div>
                             <div style="background:white; padding:12px; border-radius:12px; text-align:center; border:1px solid #fef3c7;">
                                 <div style="font-size:9px; color:#d97706; font-weight:800; letter-spacing:0.5px;">COMMERCIAL</div>
                                 <div id="set-total-commercial" style="font-size:20px; font-weight:900; color:#d97706;">0</div>
                             </div>
                         </div>
                    </div>
                    <div style="margin-top:20px; padding:16px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:16px; font-size:13px; color:#64748b; line-height:1.6;">
                        This dashboard provides real-time statistics of the survey database. Use the ðŸ“ <b>Marker Limit</b> tab if you need to adjust performance for large datasets.
                    </div>`;
                setTimeout(() => Settings.updateStats(), 50);
            } 
            else if (this.activeTab === 'ðŸ“ Marker Limit') {
                const limit = State.markerLimit >= 999999 ? 'No Limit' : State.markerLimit.toLocaleString();
                contentHtml += `
                    <div style="padding:4px;">
                        <div style="display:flex; justify-content:space-between; align-items:baseline; margin-bottom:20px; background: #fff; padding:16px; border-radius:16px; border:1px solid #f1f5f9;">
                            <div>
                                <label style="font-weight:800; font-size:11px; color:#94a3b8; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">Current Map Limit</label>
                                <span style="font-weight:900; font-size:28px; color:var(--primary);">${limit === 'No Limit' ? 'âˆž' : limit}</span>
                            </div>
                            <span class="material-icons-round" style="font-size:40px; color:#dbeafe;">speed</span>
                        </div>
                        <div style="font-size:12px; color:#64748b; margin-bottom:20px; line-height:1.5;">Higher limits allow visualizing more data but may impact performance on older mobile devices.</div>
                        
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                            <button onclick="Settings.setMarkerLimit(5000)" class="secondary-btn" style="margin:0; justify-content:center;">5,000</button>
                            <button onclick="Settings.setMarkerLimit(10000)" class="secondary-btn" style="margin:0; justify-content:center;">10,000</button>
                            <button onclick="Settings.setMarkerLimit(20000)" class="secondary-btn" style="margin:0; justify-content:center;">20,000</button>
                            <button onclick="Settings.setMarkerLimit(50000)" class="secondary-btn" style="margin:0; justify-content:center;">50,000</button>
                            <button onclick="Settings.setMarkerLimit(999999)" class="secondary-btn" style="margin:0; justify-content:center; grid-column: span 2; background:#f0f7ff; border-color:#dbeafe; color:#2563eb;">Show All Records</button>
                        </div>
                        
                        <div style="display:flex; gap:10px;">
                            <button onclick="Settings.incrementMarkerLimit(-5000)" style="flex:1; padding:14px; border-radius:12px; border:1px solid #e2e8f0; background:white; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; color:#64748b;">
                                <span class="material-icons-round" style="font-size:18px;">remove_circle_outline</span> -5K
                            </button>
                            <button onclick="Settings.incrementMarkerLimit(5000)" style="flex:1; padding:14px; border-radius:12px; border:1px solid #e2e8f0; background:white; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; color:#2563eb;">
                                <span class="material-icons-round" style="font-size:18px;">add_circle_outline</span> +5K
                            </button>
                        </div>
                    </div>`;
            }
            else {
                // KML Cities Sections
                const layers = GEO_LAYERS[this.activeTab] || {};
                const sortedLayers = Object.keys(layers).sort();
                
                if(sortedLayers.length === 0) {
                    contentHtml += '<div style="padding:60px 20px; text-align:center; color:#94a3b8;">' +
                                   '<span class="material-icons-round" style="font-size:48px; display:block; margin-bottom:12px; opacity:0.3;">layers_clear</span>' +
                                   'No boundary layers for this city.</div>';
                } else {
                    contentHtml += `<div class="kml-grid">`;
                    sortedLayers.forEach(layerName => {
                        const key = `${this.activeTab}|${layerName}`;
                        const isChecked = this.pendingSelections.has(key);
                        contentHtml += `
                            <div class="multi-option ${isChecked ? 'selected' : ''}" onclick="LayerManager.toggleSelection('${key}')" 
                                 style="padding:12px; margin:0; border:1px solid ${isChecked ? '#bfdbfe' : '#f1f5f9'}; border-radius:12px; 
                                 display:flex; align-items:center; gap:10px; cursor:pointer; background:${isChecked ? '#eff6ff' : 'white'}; transition:all 0.2s;">
                                <div style="width:20px; height:20px; border:1.5px solid ${isChecked ? '#2563eb' : '#cbd5e1'}; border-radius:6px; 
                                            display:flex; align-items:center; justify-content:center; background:${isChecked ? '#2563eb' : 'transparent'};">
                                    ${isChecked ? '<span class="material-icons-round" style="font-size:14px; color:white;">check</span>' : ''}
                                </div>
                                <span style="font-size:12px; font-weight:600; color:${isChecked ? '#1e40af' : '#64748b'}; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${layerName}</span>
                            </div>`;
                    });
                    contentHtml += `</div>`;
                    
                    contentHtml += `
                        <div style="margin-top:24px; display:flex; gap:12px;">
                            <button onclick="LayerManager.clearCity()" style="flex:1; padding:10px; font-size:11px; color:#64748b; font-weight:700; background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
                                <span class="material-icons-round" style="font-size:16px;">clear_all</span> Uncheck City
                            </button>
                            <button onclick="LayerManager.clear()" style="flex:1; padding:10px; font-size:11px; color:#ef4444; font-weight:700; background:#fef2f2; border:1px solid #fee2e2; border-radius:10px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
                                <span class="material-icons-round" style="font-size:16px;">delete_sweep</span> Clear All Map
                            </button>
                        </div>`;
                }
            }
            contentHtml += '</div>';
            
            // Re-Styled Footer
            const isKmlTab = kmlCities.includes(this.activeTab);
            const footerHtml = isKmlTab ? `
                <div class="settings-footer">
                     <button onclick="Settings.close()" style="flex:0.4; padding:12px; border-radius:12px; border:1px solid #e2e8f0; background:white; color:#64748b; font-weight:700; cursor:pointer;">Cancel</button>
                     <button onclick="LayerManager.applySettings()" class="btn-primary" 
                        style="flex:1; border-radius:12px; padding:12px; display:flex; justify-content:center; gap:10px; align-items:center; background:#2563eb; color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer; box-shadow: 0 4px 12px rgba(37,99,235,0.2);">
                        <span class="material-icons-round" style="font-size:20px;">task_alt</span> Apply Boundary Layers
                     </button>
                </div>` : `
                <div class="settings-footer" style="padding:12px 24px;">
                    <div style="font-size:11px; color:#94a3b8; font-weight:600;">v6.0 Build â€¢ Super-App Core</div>
                    <button onclick="Settings.close()" style="margin-left:auto; padding:8px 20px; border-radius:20px; border:1px solid #e2e8f0; background:white; font-weight:700; font-size:12px; cursor:pointer;">Close</button>
                </div>`;
            
            container.innerHTML = tabsHtml + contentHtml + footerHtml;
        },
        
        switchTab(city) {
            this.activeTab = city;
            this.renderSettingsUI();
        },
        
        toggleSelection(key) {
            if(this.pendingSelections.has(key)) {
                this.pendingSelections.delete(key);
            } else {
                this.pendingSelections.add(key);
            }
            this.renderSettingsUI();
        },
        
        applySettings() {
            // Convert Set to Array and Load
            const keys = Array.from(this.pendingSelections);
            this.load(keys);
            
            // Close Settings Modal
            document.getElementById('modal-settings').style.display = 'none';
            this.showToast(`Active Layers: ${keys.length}`);
        },

        clearCity() {
            const city = this.activeTab;
            for(let key of this.pendingSelections) {
                if(key.startsWith(city + '|')) {
                    this.pendingSelections.delete(key);
                }
            }
            this.renderSettingsUI();
        }
    };


    
    // Attach Gallery Events
    const galVp = document.getElementById('gal-vp');
    galVp.addEventListener('mousedown', e => Gallery.onStart(e));
    galVp.addEventListener('mousemove', e => Gallery.onMove(e));
    galVp.addEventListener('touchstart', e => Gallery.onStart(e), {passive: false});
    galVp.addEventListener('touchmove', e => Gallery.onMove(e), {passive: false});
    galVp.addEventListener('wheel', e => Gallery.onWheel(e), {passive: false});
    galVp.addEventListener('click', e => Gallery.clickNav(e));
    galVp.addEventListener('dblclick', () => Gallery.reset());

    // Window level listeners to catch drag releases outside the viewport
    window.addEventListener('mouseup', () => Gallery.onEnd());
    window.addEventListener('touchend', () => Gallery.onEnd());
    window.addEventListener('mouseleave', () => Gallery.onEnd());



    const Sidebar = {
        init() {
            // Auto-close on map click for mobile
            const mapC = document.getElementById('main-stage');
            if(mapC) {
                mapC.addEventListener('click', (e) => {
                    // Only if clicking map directly (not controls) and on mobile
                    if(window.innerWidth <= 768 && 
                       document.getElementById('sidebar').classList.contains('open') &&
                       !e.target.closest('.map-controls') &&
                       !e.target.closest('.float-btn')) {
                        this.close();
                    }
                });
            }
        },
        toggle() { 
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('open');
            const isOpen = sb.classList.contains('open');
            
            // Toggle Info Card visibility
            const card = document.getElementById('info-card');
            if(card) {
                if(isOpen && window.innerWidth <= 768) card.classList.add('hidden');
                else card.classList.remove('hidden');
            }
        },
        toggleDesktop() {
            const sb = document.getElementById('sidebar');
            const btn = document.getElementById('sidebar-toggle');
            sb.classList.toggle('collapsed');
            btn.classList.toggle('collapsed-toggle');
            
            // Refresh map size after transition
            setTimeout(() => {
                if(State.map) State.map.invalidateSize({ animate: true });
            }, 450); 
        },
        close() { 
            document.getElementById('sidebar').classList.remove('open'); 
            const card = document.getElementById('info-card');
            if(card) card.classList.remove('hidden');
        }
    };
    
    const InfoCard = {
        init() {
            if(typeof RAW_DATA === 'undefined') return;
            
            // 1. Calculate Stats
            const total = RAW_DATA.length;
            const byTehsil = {};
            
            RAW_DATA.forEach(r => {
                const tehsil = r[11]; // Tehsil Name
                const type = r[3];    // 1=Com, 0=Dom
                
                if(!byTehsil[tehsil]) byTehsil[tehsil] = { t:0, d:0, c:0 };
                byTehsil[tehsil].t++;
                if(type === 1) byTehsil[tehsil].c++;
                else byTehsil[tehsil].d++;
            });
            
            // 2. Build HTML
            const isMin = document.getElementById('info-card').classList.contains('minimized');
            const toggleIcon = isMin ? 'expand_more' : 'expand_less';
            const headerStyle = isMin 
                ? 'display:flex; justify-content:space-between; align-items:center;' 
                : 'padding-bottom:12px; border-bottom:1px solid #f1f5f9; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;';

            let html = `
                <div style="${headerStyle}">
                    <div>
                        <div style="font-size:10px; color:#64748b; font-weight:800; letter-spacing:1px; text-transform:uppercase; margin-bottom:4px;">${isMin ? '' : 'Total Surveys'}</div>
                        <div style="font-size:24px; font-weight:800; color:var(--primary); line-height:1;">${total.toLocaleString()}</div>
                    </div>
                    <button onclick="InfoCard.toggle()" style="background:none; border:none; cursor:pointer; color:#94a3b8; padding:4px;">
                        <span class="material-icons-round">${toggleIcon}</span>
                    </button>
                </div>
                <div id="info-content" style="flex:1; overflow-y:auto; padding-right:4px; display:${isMin ? 'none' : 'block'}">
            `;
            
            // Sort Tehsils by count
            const sorted = Object.entries(byTehsil).sort((a,b) => b[1].t - a[1].t);
            
            sorted.forEach(([name, data]) => {
                html += `
                    <div class="info-stat-row">
                        <div class="info-label">${name}</div>
                        <div class="info-val">
                           <span class="pill dom" title="Domestic">Dom: ${data.d}</span>
                           <span class="pill com" title="Commercial">Com: ${data.c}</span>
                           <span style="min-width:30px; text-align:right;">${data.t}</span>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            document.getElementById('info-card').innerHTML = html;
        },
        
        toggle() {
            const card = document.getElementById('info-card');
            card.classList.toggle('minimized');
            this.init(); // Re-render to update icon/content
        }
    };

    const Settings = {
        open() {
            try {
                if(typeof LayerManager !== 'undefined') {
                     LayerManager.initPendingState();
                     LayerManager.renderSettingsUI();
                }
            } catch(e) { console.error("LayerManager error:", e); }
            document.getElementById('modal-settings').style.display = 'flex';
        },
        
        updateStats() {
            if(typeof RAW_DATA === 'undefined') return;
            const total = RAW_DATA.length;
            // Type 1 = Commercial, Others = Domestic
            const comm = RAW_DATA.filter(r => r[3] === 1).length;
            const dom = total - comm;
            
            const elTotal = document.getElementById('set-total-surveys');
            const elDom = document.getElementById('set-total-domestic');
            const elComm = document.getElementById('set-total-commercial');
            
            if(elTotal) elTotal.innerText = total.toLocaleString();
            if(elDom) elDom.innerText = dom.toLocaleString();
            if(elComm) elComm.innerText = comm.toLocaleString();
        },
        
        close() {
            document.getElementById('modal-settings').style.display = 'none';
        },
        
        setMarkerLimit(limit) {
            State.markerLimit = limit;
            LayerManager.renderSettingsUI();
            App.render();
        },
        
        incrementMarkerLimit(amount) {
            State.markerLimit = Math.max(5000, State.markerLimit + amount);
            LayerManager.renderSettingsUI();
            App.render();
        }
    };

    // Keyboard support for List View
    window.addEventListener('keydown', e => {
        if(!document.getElementById('list-view-stage').classList.contains('active')) return;
        // Block List View navigation if Gallery is active
        if(document.getElementById('gallery').classList.contains('active')) return;
        
        if(e.key === 'ArrowRight') ListView.next();
        if(e.key === 'ArrowLeft') ListView.prev();
    });

    // Touch support for List View
    let touchStartX = 0;
    let touchStartY = 0;
    document.getElementById('lv-content').addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
    }, {passive: true});
    
    document.getElementById('lv-content').addEventListener('touchend', e => {
        const deltaX = touchStartX - e.changedTouches[0].screenX;
        const deltaY = touchStartY - e.changedTouches[0].screenY;
        
        // Threshold check (increase to 100px) and Axis check (ensure horizontal dominance)
        if(Math.abs(deltaX) > 100 && Math.abs(deltaX) > Math.abs(deltaY) * 1.5) {
            deltaX > 0 ? ListView.next() : ListView.prev();
        }
    }, {passive: true});

    const PerformanceLog = {
        customStartDate: null,
        
        updateDate(val) {
            this.customStartDate = val;
            this.open();
        },
        
        open() {
            // 1. Setup Dates
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            
            // Default to 1st of current month if not set
            if(!this.customStartDate) {
                this.customStartDate = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-01`;
            }
            
            // Update input if exists
            const dateInput = document.getElementById('att-start-date');
            if(dateInput) dateInput.value = this.customStartDate;

            const startStr = this.customStartDate;
            const monthName =  new Date(startStr).toLocaleString('default', { month: 'long', year: 'numeric' });
            
            // 2. Aggregate Data by Staff -> Date
            const staffData = {};
            
            RAW_DATA.forEach(r => {
                const staff = r[6], d = r[7];
                if(d < startStr || d > todayStr) return;
                
                if(!staffData[staff]) staffData[staff] = {};
                if(!staffData[staff][d]) staffData[staff][d] = [];
                staffData[staff][d].push(r);
            });

            // 3. Process Monthly Stats per Staff
            const summary = [];
            
            Object.keys(staffData).forEach(name => {
                const dates = Object.keys(staffData[name]).sort();
                let daysActive = dates.length;
                let targetMet = 0;
                let pmMet = 0;
                let workflowMet = 0;
                let absents = 0;
                
                dates.forEach(d => {
                    const recs = staffData[name][d].sort((a,b) => a[8].localeCompare(b[8]));
                    const total = recs.length;
                    
                    // PM Count (14:00 - 16:55)
                    const pmCount = recs.filter(r => r[8] >= "14:00:00" && r[8] <= "16:55:00").length;
                    
                    // Idle Count
                    let idleCount = 0;
                    const winStart = "10:00:00", winEnd = "16:55:00";
                    for(let i=1; i<recs.length; i++) {
                        const t1 = recs[i-1][8], t2 = recs[i][8];
                        if(t1 < winStart || t1 > winEnd) continue;
                        
                        const d1 = new Date(`2000-01-01T${t1}`), d2 = new Date(`2000-01-01T${t2}`);
                        let diff = (d2 - d1) / 60000;
                        
                        // Lunch correction
                        const lS = new Date(`2000-01-01T13:00:00`), lE = new Date(`2000-01-01T14:00:00`);
                        const oS = new Date(Math.max(d1, lS)), oE = new Date(Math.min(d2, lE));
                        if(oE > oS) diff -= (oE - oS) / 60000;
                        
                        if(diff > 30) idleCount++;
                    }
                    
                    // Check Rules
                    const ruleTarget = total >= 100;
                    const rulePM = pmCount >= 30;
                    const ruleIdle = idleCount <= 3;
                    
                    if(ruleTarget) targetMet++;
                    if(rulePM) pmMet++;
                    if(ruleIdle) workflowMet++;
                    
                    // If Fails ALL 3 -> Absent
                    if(!ruleTarget && !rulePM && !ruleIdle) absents++;
                });
                
                summary.push({ name, daysActive, targetMet, pmMet, workflowMet, absents });
            });
            
            // Sort by Absents (desc) then Name
            summary.sort((a,b) => b.absents - a.absents || a.name.localeCompare(b.name));

            // 4. Render HTML
            if(document.getElementById('log-subtitle')) {
                document.getElementById('log-subtitle').innerText = `Summary â€¢ ${startStr} to Present`;
            }

            let html = `
                <div class="guide-box">
                    <h4>Performance Summary</h4>
                    <div style="font-size:12px; color:#64748b; margin-bottom:8px;">
                        Showing stats from <b>${startStr}</b> to <b>${todayStr}</b>.
                        <br><b>Absence</b> = Days failing all 3 rules (Target < 100, PM < 30, Idle > 3).
                    </div>
                </div>
                <table class="perf-table" style="width:100%; border-collapse:collapse; font-size:13px; min-width:600px;">
                <thead style="background:#f8fafc; position:sticky; top:0; z-index:20;">
                    <tr>
                        <th style="padding:12px; text-align:left;">Staff Name</th>
                        <th style="padding:12px; text-align:center;">Days Active</th>
                        <th style="padding:12px; text-align:center;">Target Met (Days)</th>
                        <th style="padding:12px; text-align:center;">PM Rule Met (Days)</th>
                        <th style="padding:12px; text-align:center;">Workflow Met (Days)</th>
                        <th style="padding:12px; text-align:center;">Total Absents</th>
                    </tr>
                </thead>
                <tbody>`;

            summary.forEach(r => {
                const absDisplay = r.absents > 0 
                    ? `<span style="color:var(--danger); font-weight:800; font-size:15px;">-${r.absents} Days</span>` 
                    : '<span style="color:#cbd5e1">-</span>';
                    
                html += `<tr class="rank-row">
                    <td style="padding:12px;">
                        <div style="font-weight:700">${r.name}</div>
                    </td>
                    <td style="padding:12px; text-align:center;">
                        <b>${r.daysActive}</b>
                    </td>
                    <td style="padding:12px; text-align:center;">
                        <span style="color:${r.targetMet === r.daysActive ? 'var(--primary)' : 'var(--text)'}">${r.targetMet}</span>
                        <span style="color:#94a3b8; font-size:10px;">/ ${r.daysActive}</span>
                    </td>
                    <td style="padding:12px; text-align:center;">
                        <span style="color:${r.pmMet === r.daysActive ? 'var(--primary)' : 'var(--text)'}">${r.pmMet}</span>
                        <span style="color:#94a3b8; font-size:10px;">/ ${r.daysActive}</span>
                    </td>
                    <td style="padding:12px; text-align:center;">
                        <span style="color:${r.workflowMet === r.daysActive ? 'var(--primary)' : 'var(--text)'}">${r.workflowMet}</span>
                        <span style="color:#94a3b8; font-size:10px;">/ ${r.daysActive}</span>
                    </td>
                    <td style="padding:12px; text-align:center;">
                        ${absDisplay}
                    </td>
                </tr>`;
            });

            html += `</tbody></table>`;
            document.getElementById('log-body').innerHTML = html;
            document.getElementById('modal-log').style.display = 'flex';
        },
        close() { document.getElementById('modal-log').style.display = 'none'; }
    };

    // Expose Globals explicitly for inline event handlers
    window.State = State;
    window.App = App;
    window.Sidebar = Sidebar;
    window.InfoCard = InfoCard;
    window.Settings = Settings;
    window.Gallery = Gallery;
    window.DriveSync = DriveSync;
    window.LayerManager = LayerManager;
    window.ViewSwitcher = ViewSwitcher;
    window.ListView = ListView;
    window.PerformanceLog = PerformanceLog;

    const BillVerifier = {
        URL: 'https://suthra.punjab.gov.pk/verify-bill',
        open(psid = '') {
            const modal = document.getElementById('modal-verify-bill');
            const iframe = document.getElementById('verify-iframe');
            const loader = document.getElementById('verify-loader');
            const label = document.getElementById('verify-psid-label');
            
            label.innerText = psid ? `VERIFYING PSID: ${psid}` : 'EXTERNAL: SUTHRA PUNJAB';
            loader.style.display = 'flex';
            iframe.src = this.URL;
            modal.style.display = 'flex';
            
            if(psid) {
                console.log("Tip: Copy PSID", psid, "to verify on the portal.");
                
                const copySuccess = () => {
                    App.showToast ? App.showToast("PSID Copied! Click portal & Paste (Ctrl+V)") : console.log("PSID Copied");
                };

                if(navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(psid).then(copySuccess).catch(() => {
                        // If clipboard API fails, try fallback
                        this.fallbackCopy(psid);
                        copySuccess();
                    });
                } else {
                    this.fallbackCopy(psid);
                    copySuccess();
                }
            }
        },
        fallbackCopy(text) {
            try {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";  // Avoid scrolling to bottom
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                return successful;
            } catch (err) {
                console.error('Fallback copy failed', err);
                return false;
            }
        },
        close() {
            const modal = document.getElementById('modal-verify-bill');
            const iframe = document.getElementById('verify-iframe');
            iframe.src = ''; // Clear src to stop loading
            modal.style.display = 'none';
            // Return to origin if applicable
            if (State.originView === 'dashboard') ViewSwitcher.toDashboard();
        }
    };
    const PaidBills = {
        data: [],
        filtered: [],
        currentPage: 1,
        rowsPerPage: 10,
        activeType: 'all',
        idStatus: 'all',
        _fpStart: null,
        _fpEnd: null,

        setType(type) {
            this.activeType = (this.activeType === type) ? 'all' : type;
            this.currentPage = 1;
            this.render();
        },

        init() {
            const selector = document.getElementById('pb-city');
            const typeSelector = document.getElementById('pb-type');
            if(!selector) return;

            // 1. Clear and Populate selectors
            selector.innerHTML = '<option value="all">All Cities</option>';
            typeSelector.innerHTML = '<option value="all">All Categories</option>';

            const cities = new Set();
            const categories = new Set();
            PAID_DATA.forEach(r => {
                if(r[3] && r[3] !== '-') cities.add(r[3]);
                if(r[7] && r[7] !== '-') categories.add(r[7]);
            });
            Array.from(cities).sort().forEach(city => {
                const opt = document.createElement('option');
                opt.value = city; opt.innerText = city;
                selector.appendChild(opt);
            });
            Array.from(categories).sort().forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat; opt.innerText = cat;
                typeSelector.appendChild(opt);
            });
            selector.value = 'all';
            typeSelector.value = 'all';

            // 2. Initialize Flatpickr
            const commonCfg = {
                dateFormat: "Y-m-d",
                onChange: () => this.render(),
                disableMobile: false
            };
            this._fpStart = flatpickr("#pb-date-start", commonCfg);
            this._fpEnd = flatpickr("#pb-date-end", commonCfg);
        },

        open() {
            if(!this._fpStart) this.init();
            
            if(!document.getElementById('pb-date-start').value) {
                const now = new Date();
                const today = now.toISOString().split('T')[0];
                this._fpStart.setDate(today);
                this._fpEnd.setDate(today);
            }

            this.currentPage = 1;
            this.render();
            ViewSwitcher.toDashboard();
        },

        render() {
            const start = document.getElementById('pb-date-start').value;
            const end = document.getElementById('pb-date-end').value;
            const city = document.getElementById('pb-city').value;
            const category = document.getElementById('pb-type').value;
            const idStatus = document.getElementById('pb-id-status')?.value || 'all';
            const tbody = document.getElementById('pb-table-body');
            
            // 1. Filter PAID_DATA
            this.filtered = PAID_DATA.filter(r => {
                const rSID = r[1];
                const rDate = r[11]; // Paid Date
                const rCity = r[3];
                const rCat = r[7];

                if (start && rDate < start) return false;
                if (end && rDate > end) return false;
                if (city !== 'all' && rCity !== city) return false;
                if (category !== 'all' && rCat !== category) return false;
                
                // ID Status Filter
                if (idStatus === 'deleted' && rSID !== 'Deleted ID') return false;
                if (idStatus === 'active' && rSID === 'Deleted ID') return false;

                // Type Quick Filters (Domestic / Commercial)
                if (this.activeType === 'domestic' && !rCat.toUpperCase().includes('DOMESTIC')) return false;
                if (this.activeType === 'commercial' && !rCat.toUpperCase().includes('COMMERCIAL')) return false;

                return true;
            });

            // 2. Filtered Stats (Reflect CURRENT results)
            let filteredAmount = 0;
            this.filtered.forEach(r => filteredAmount += parseFloat(r[12]) || 0);
            
            document.getElementById('pb-total-amount').innerText = `Rs. ${filteredAmount.toLocaleString()}`;
            document.getElementById('pb-total-count').innerText = this.filtered.length.toLocaleString();
            document.getElementById('pb-avg-amount').innerText = this.filtered.length ? `Rs. ${Math.round(filteredAmount/this.filtered.length).toLocaleString()}` : 'Rs. 0';

            // 3. Pagination Slicing
            const totalRecords = this.filtered.length;
            const totalPages = Math.ceil(totalRecords / this.rowsPerPage) || 1;
            if (this.currentPage > totalPages) this.currentPage = totalPages;
            if (this.currentPage < 1) this.currentPage = 1;

            const startIdx = (this.currentPage - 1) * this.rowsPerPage;
            const pageData = this.filtered.slice(startIdx, startIdx + parseInt(this.rowsPerPage));

            // 4. Render Table Rows
            if (pageData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="13" style="text-align:center; padding:60px; color:#94a3b8;">
                    <span class="material-icons-round" style="font-size:48px; opacity:0.2; display:block; margin-bottom:10px;">search_off</span>
                    No records found for the selected criteria.
                    <br><small>Global Registry contains ${PAID_DATA.length} records.</small>
                </td></tr>`;
            } else {
                tbody.innerHTML = pageData.map(r => {
                    const sid = r[1];
                    const sidDisplay = sid === "Deleted ID" ? `<span class="paid-deleted-id">Deleted ID</span>` : `<span class="paid-id-link">#${sid}</span>`;
                    
                    return `
                        <tr onclick="PaidBills.jumpToRecord('${sid}')">
                            <td>${r[0]}</td> <!-- Sr# -->
                            <td>${sidDisplay}</td>
                            <td style="font-family:monospace; font-weight:700; color:#475569;">${r[2]}</td> <!-- PSID -->
                            <td>${r[3]}</td> <!-- City -->
                            <td>${r[4]}</td> <!-- Month -->
                            <td>${r[5]}</td> <!-- Office -->
                            <td>${r[6]}</td> <!-- UC -->
                            <td style="font-size:11px; font-weight:700; color:#64748b;">${r[7]}</td> <!-- Category -->
                            <td>Rs. ${parseFloat(r[8]).toLocaleString()}</td> <!-- Due Amt -->
                            <td>Rs. ${parseFloat(r[9]).toLocaleString()}</td> <!-- Fine -->
                            <td style="font-size:11px; font-weight:700; color:#64748b;">${r[10]}</td> <!-- Channel -->
                            <td style="font-weight:600;">${r[11]}</td> <!-- Date -->
                            <td style="font-weight:800; color:#16a34a;">Rs. ${parseFloat(r[12]).toLocaleString()}</td> <!-- Paid Amt -->
                        </tr>
                    `;
                }).join('');
            }

            // 5. Update Footer
            const endIdx = Math.min(startIdx + parseInt(this.rowsPerPage), totalRecords);
            document.getElementById('pb-record-range').innerText = totalRecords ? `Showing ${startIdx + 1}-${endIdx} of ${totalRecords}` : 'Showing 0-0';
            document.getElementById('pb-page-info').innerText = `Page ${this.currentPage} of ${totalPages}`;
            document.getElementById('pb-prev').disabled = this.currentPage <= 1;
            document.getElementById('pb-next').disabled = this.currentPage >= totalPages;

            // 5.5 Update Button Visual States
            document.querySelectorAll('.dash-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-type') === this.activeType);
            });
            const allBtn = document.getElementById('pb-all-records-btn');
            if(allBtn) allBtn.classList.toggle('active', this.activeType === 'all');

            // 6. Sidebar Analytics (UC and Category breakdown)
            this.renderAnalyticPanels();
        },

        renderAnalyticPanels() {
            // UC Breakdown (Left)
            const ucMap = {}; // { UC: { amount, count } }
            this.filtered.forEach(r => {
                const uc = r[6] || 'Unassigned';
                if(!ucMap[uc]) ucMap[uc] = { amt: 0, count: 0 };
                ucMap[uc].amt += parseFloat(r[12]) || 0;
                ucMap[uc].count++;
            });

            const ucSorted = Object.entries(ucMap).sort((a,b) => b[1].amt - a[1].amt);
            const ucList = document.getElementById('pb-uc-summary');
            ucList.innerHTML = ucSorted.map(([name, data], idx) => {
                const isTop5 = idx < 5;
                const badge = isTop5 ? `<span class="top-5-badge">#${idx+1} TOP PERFORMANCE</span>` : "";
                return `
                    <div class="analytics-item">
                        <div style="flex:1">
                            <div class="name">${name}</div>
                            ${badge}
                        </div>
                        <div class="value">
                            <div>Rs. ${Math.round(data.amt).toLocaleString()}</div>
                            <div class="sub">${data.count} Bills</div>
                        </div>
                    </div>
                `;
            }).join('');

            // Category Breakdown (Right)
            const catMap = {};
            this.filtered.forEach(r => {
                const cat = r[7] || 'Other';
                if(!catMap[cat]) catMap[cat] = { amt: 0, count: 0 };
                catMap[cat].amt += parseFloat(r[12]) || 0;
                catMap[cat].count++;
            });

            const catSorted = Object.entries(catMap).sort((a,b) => b[1].amt - a[1].amt);
            const catList = document.getElementById('pb-category-summary');
            catList.innerHTML = catSorted.map(([name, data]) => `
                <div class="analytics-item">
                    <div class="name" style="font-size:11px">${name}</div>
                    <div class="value">
                        <div style="color:var(--primary)">Rs. ${Math.round(data.amt).toLocaleString()}</div>
                        <div class="sub">${data.count} Bills</div>
                    </div>
                </div>
            `).join('');
        },

        setRows(val) {
            this.rowsPerPage = parseInt(val);
            this.currentPage = 1;
            this.render();
        },

        changePage(delta) {
            this.currentPage += delta;
            this.render();
            document.querySelector('.paid-table-container').scrollTop = 0;
        },

        jumpToRecord(id) {
            if(id === "Deleted ID" || !id) {
                App.showToast ? App.showToast("Record not available.") : alert("Record missing");
                return;
            }
            // IMMEDIATE V7.3.5 FIX: FORCE HIDE STAGE
            const stage = document.getElementById('paid-dashboard-stage');
            if(stage) stage.style.display = 'none';
            
            State.originView = 'dashboard';
            ListView.jumpFromMap(id);
        },

        toggleSidebar() {
            const layout = document.getElementById('dash-layout');
            const sidebar = document.getElementById('dash-sidebar');
            layout.classList.toggle('sidebar-collapsed');
            sidebar.classList.toggle('active');
        },

        reset() {
            document.getElementById('pb-city').value = 'all';
            document.getElementById('pb-type').value = 'all';
            const statusEl = document.getElementById('pb-id-status');
            if(statusEl) statusEl.value = 'all';
            this.activeType = 'all';
            
            if(this._fpStart) this._fpStart.clear();
            if(this._fpEnd) this._fpEnd.clear();
            this.currentPage = 1;
            this.render();
        },

        close() { 
            ViewSwitcher.toMap();
            Sidebar.close();
        }
    };
    const UniversalSearch = {
        _timeout: null,
        open() {
            const modal = document.getElementById('modal-search');
            modal.style.display = 'flex';
            const input = document.getElementById('universal-search-input');
            input.value = '';
            input.focus();
            this.renderResults([]);
        },
        close() {
            document.getElementById('modal-search').style.display = 'none';
        },
        handleInput(val) {
            if(this._timeout) clearTimeout(this._timeout);
            this._timeout = setTimeout(() => this.performSearch(val), 300);
        },
        performSearch(query) {
            const q = query.trim().toLowerCase();
            if(!q) {
                this.renderResults([]);
                return;
            }
            
            const results = RAW_DATA.filter(r => {
                // SID, PSID, Name, Addr, Surveyor
                return (r[0] && r[0].toString().toLowerCase().includes(q)) ||
                       (r[15] && r[15].toString().toLowerCase().includes(q)) ||
                       (r[4] && r[4].toLowerCase().includes(q)) ||
                       (r[5] && r[5].toLowerCase().includes(q)) ||
                       (r[6] && r[6].toLowerCase().includes(q));
            }).slice(0, 50);

            this.renderResults(results);
        },
        renderResults(results) {
            const container = document.getElementById('search-results-list');
            document.getElementById('search-count').innerText = `${results.length} RECORDS FOUND`;
            
            if(results.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:40px; color:#94a3b8;">
                        <span class="material-icons-round" style="font-size:48px; opacity:0.3; margin-bottom:8px;">search_off</span>
                        <div>No matching records found.</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = results.map(r => `
                <div class="search-item">
                    <div class="search-item-main" onclick="UniversalSearch.jump('${r[0]}', 'list')" style="flex:1">
                        <div class="search-item-title">#${r[0]} | ${r[4]}</div>
                        <div class="search-item-sub">${r[15]} | ${r[5]}</div>
                        <div class="search-item-meta">${r[11]} - ${r[12]}</div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end; padding-left:12px;">
                         <div style="display:flex; gap:8px;">
                            <button class="float-btn" onclick="UniversalSearch.jump('${r[0]}', 'map')" title="View on Map" style="width:36px; height:36px; background:#eff6ff; color:#2563eb; border:1px solid #dbeafe;">
                                <span class="material-icons-round" style="font-size:20px;">map</span>
                            </button>
                            <button class="float-btn" onclick="UniversalSearch.jump('${r[0]}', 'list')" title="View in List" style="width:36px; height:36px; background:#f0fdf4; color:#16a34a; border:1px solid #dcfce7;">
                                <span class="material-icons-round" style="font-size:20px;">view_list</span>
                            </button>
                         </div>
                         <div class="search-badge" style="margin:0">${r[6]}</div>
                    </div>
                </div>
            `).join('');
        },
        jump(id, mode) {
            this.close();
            if (mode === 'map') {
                ListView.showOnMap(id);
            } else {
                ListView.jumpFromMap(id);
            }
        }
    };

    window.UniversalSearch = UniversalSearch;
    window.PaidBills = PaidBills;
    window.BillVerifier = BillVerifier;

    // Global Key Handlers
    document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape') {
            UniversalSearch.close();
            PaidBills.close();
            BillVerifier.close();
            if(typeof Gallery !== 'undefined') Gallery.close();
        }
    });


    window.onload = () => {
        // App.init();
        
        // Prevent Accidental Exit
        window.addEventListener('beforeunload', (e) => {
            e.preventDefault();
            e.returnValue = ''; // Standard requirement for modern browsers
        });

        // Handle Mobile Back Button (Push a dummy state to history)
        window.history.pushState({page: 1}, "", "");
        window.onpopstate = function(event) {
            if(confirm("Exit App? Unsaved progress (like selected filters) will be lost.")) {
                window.history.back();
            } else {
                window.history.pushState({page: 1}, "", "");
            }
        };
    };
</script>
</body>
</html>